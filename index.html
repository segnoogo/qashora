<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qashora - Gestion de TrÃ©sorerie</title>
    <meta name="description" content="Qashora - Gestion de TrÃ©sorerie Intelligente">
    <meta name="theme-color" content="#d946ef">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='100' y2='100'%3E%3Cstop offset='0' stop-color='%23d946ef'/%3E%3Cstop offset='100' stop-color='%2322d3ee'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='url(%23g)'/%3E%3Ctext x='50' y='68' text-anchor='middle' font-size='55' font-weight='bold' fill='white'%3EQ%3C/text%3E%3C/svg%3E">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config={theme:{extend:{colors:{primary:{50:'#fdf4ff',100:'#fae8ff',200:'#f5d0fe',300:'#f0abfc',400:'#e879f9',500:'#d946ef',600:'#c026d3',700:'#a21caf',800:'#86198f',900:'#701a75'},secondary:{50:'#ecfeff',100:'#cffafe',200:'#a5f3fc',300:'#67e8f9',400:'#22d3ee',500:'#06b6d4',600:'#0891b2',700:'#0e7490',800:'#155e75',900:'#164e63'},surface:{50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',400:'#94a3b8',500:'#64748b',600:'#475569',700:'#334155',800:'#1e293b',900:'#0f172a',950:'#020617'}}}}}</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:#020617;color:#e2e8f0}.font-mono{font-family:'JetBrains Mono',monospace}
        .glass{background:rgba(30,41,59,0.95);backdrop-filter:blur(12px);border:1px solid rgba(71,85,105,0.4)}
        .gradient-primary{background:linear-gradient(135deg,#a21caf,#d946ef)}.gradient-secondary{background:linear-gradient(135deg,#0891b2,#22d3ee)}.gradient-success{background:linear-gradient(135deg,#059669,#10b981)}.gradient-danger{background:linear-gradient(135deg,#dc2626,#ef4444)}.gradient-warning{background:linear-gradient(135deg,#d97706,#f59e0b)}.gradient-indigo{background:linear-gradient(135deg,#4f46e5,#6366f1)}.gradient-gray{background:linear-gradient(135deg,#475569,#64748b)}
        @keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}@keyframes scaleIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(217,70,239,0.4)}50%{box-shadow:0 0 40px rgba(217,70,239,0.6)}}@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .animate-fade-in{animation:fadeIn 0.35s ease-out forwards}.animate-scale-in{animation:scaleIn 0.3s ease-out forwards}.animate-glow{animation:glow 2s ease-in-out infinite}.animate-spin{animation:spin 1s linear infinite}.animate-pulse{animation:pulse 2s ease-in-out infinite}.animate-slide-in{animation:slideIn 0.3s ease-out forwards}
        ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#1e293b}::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
        .stat-card{transition:all 0.3s ease}.stat-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(0,0,0,0.3)}
        .btn-primary{background:linear-gradient(135deg,#a21caf,#d946ef);transition:all 0.3s ease}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(217,70,239,0.3)}
        .nav-item{transition:all 0.25s ease}.nav-item:hover{transform:translateX(4px)}
        input:focus,select:focus,textarea:focus{outline:none;border-color:#d946ef;box-shadow:0 0 0 3px rgba(217,70,239,0.15)}
        .table-row{transition:all 0.2s ease}.table-row:hover{background:rgba(217,70,239,0.05)}
        .modal-overlay{background:rgba(0,0,0,0.8);backdrop-filter:blur(8px)}
        .chart-container{height:240px}
        .loader{border:3px solid #334155;border-top:3px solid #d946ef;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}
        @media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main-content{margin-left:0!important}}
        .notification-badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:#ef4444;border-radius:9px;font-size:10px;display:flex;align-items:center;justify-content:center}
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useMemo,useCallback}=React;

// ===== CONFIGURATION SUPABASE =====
const SUPABASE_URL='https://yxmyvfttsbzsqvixfheb.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4bXl2ZnR0c2J6c3F2aXhmaGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTMyNjMsImV4cCI6MjA4MzQyOTI2M30.kvFtPWQmcvUfLur9wEzRfnSi5S-3aEN7kJ1JJe1ZLBA';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// ===== RÃ”LES ET PERMISSIONS =====
const ROLES={Admin:{label:'Administrateur',color:'info',icon:'ğŸ‘‘',permissions:['create','read','update','delete','manage_users']},User:{label:'Utilisateur',color:'success',icon:'ğŸ‘¤',permissions:['create','read','update','delete']},Observateur:{label:'Observateur',color:'default',icon:'ğŸ‘ï¸',permissions:['read']}};
const canDo=(role,action)=>ROLES[role]?.permissions?.includes(action)||false;

// ===== PLANS D'ABONNEMENT =====
const PLANS={
    trial:{nom:'Essai Gratuit',prix:0,duree:'14 jours',color:'gray',gradient:'gradient-gray',icon:'ğŸ',limites:{banques:2,transactions:50,utilisateurs:1,exportPDF:false},features:['2 banques max','50 transactions','1 utilisateur','Export Excel uniquement','14 jours d\'essai']},
    standard:{nom:'Standard',prix:5000,duree:'mois',color:'secondary',gradient:'gradient-secondary',icon:'â­',limites:{banques:5,transactions:500,utilisateurs:3,exportPDF:true},features:['5 banques max','500 transactions/mois','3 utilisateurs','Export PDF & Excel','Support email']},
    premium:{nom:'Premium',prix:15000,duree:'mois',color:'primary',gradient:'gradient-primary',icon:'ğŸ‘‘',limites:{banques:999,transactions:999,utilisateurs:999,exportPDF:true},features:['Banques illimitÃ©es','Transactions illimitÃ©es','Utilisateurs illimitÃ©s','Export PDF & Excel','Support prioritaire']}
};
const WHATSAPP_CONTACT='+221781234567';
const SUPER_ADMINS=['admin@qashora.com','sawadgsalif@gmail.com'];

// ===== PAGE D'ACCUEIL (LANDING) =====
const LandingPage=({onGoLogin,onGoRegister})=>{
const features=[
{icon:'ğŸ“Š',title:'Tableau de bord',desc:'Vue d\'ensemble de votre trÃ©sorerie en temps rÃ©el'},
{icon:'ğŸ’°',title:'Multi-banques',desc:'GÃ©rez plusieurs comptes bancaires en un seul endroit'},
{icon:'ğŸ“‹',title:'Transactions',desc:'Suivi dÃ©taillÃ© des encaissements et dÃ©caissements'},
{icon:'ğŸ“ˆ',title:'Rapports',desc:'Graphiques et analyses pour piloter vos finances'},
{icon:'ğŸ‘¥',title:'Multi-utilisateurs',desc:'Collaboration avec gestion des rÃ´les'},
{icon:'ğŸ“±',title:'Responsive',desc:'Accessible sur ordinateur, tablette et mobile'}
];

return(<div className="min-h-screen bg-surface-950">
{/* Header */}
<header className="fixed top-0 left-0 right-0 z-50 bg-surface-900/80 backdrop-blur-xl border-b border-surface-800">
<div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
<div className="flex items-center gap-3">
<div className="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg">Q</div>
<span className="text-xl font-bold bg-gradient-to-r from-primary-400 to-secondary-400 bg-clip-text text-transparent">Qashora</span>
</div>
<div className="flex items-center gap-3">
<button onClick={onGoLogin} className="px-4 py-2 text-surface-300 hover:text-white transition-colors font-medium">Connexion</button>
<button onClick={onGoRegister} className="px-5 py-2 gradient-primary text-white rounded-xl font-bold hover:shadow-lg hover:shadow-primary-500/30 transition-all">S'inscrire</button>
</div>
</div>
</header>

{/* Hero */}
<section className="pt-32 pb-20 px-4">
<div className="max-w-4xl mx-auto text-center">
<div className="inline-flex items-center gap-2 px-4 py-2 bg-primary-500/10 border border-primary-500/30 rounded-full text-primary-400 text-sm font-medium mb-6">
<span className="animate-pulse">âœ¨</span> Gestion de trÃ©sorerie simplifiÃ©e
</div>
<h1 className="text-4xl md:text-6xl font-bold text-white mb-6 leading-tight">
Pilotez votre <span className="bg-gradient-to-r from-primary-400 to-secondary-400 bg-clip-text text-transparent">trÃ©sorerie</span> en toute simplicitÃ©
</h1>
<p className="text-xl text-surface-400 mb-8 max-w-2xl mx-auto">
Qashora vous aide Ã  gÃ©rer vos flux financiers, suivre vos comptes bancaires et prendre les meilleures dÃ©cisions pour votre entreprise.
</p>
<div className="flex flex-col sm:flex-row items-center justify-center gap-4">
<button onClick={onGoRegister} className="w-full sm:w-auto px-8 py-4 gradient-primary text-white rounded-xl font-bold text-lg hover:shadow-xl hover:shadow-primary-500/30 transition-all hover:-translate-y-1">
ğŸš€ Commencer gratuitement
</button>
<button onClick={onGoLogin} className="w-full sm:w-auto px-8 py-4 bg-surface-800 text-surface-200 rounded-xl font-bold text-lg hover:bg-surface-700 transition-all border border-surface-700">
Se connecter
</button>
</div>
<p className="text-surface-500 text-sm mt-4">14 jours d'essai gratuit â€¢ Aucune carte requise</p>
</div>
</section>

{/* Features */}
<section className="py-20 px-4 bg-surface-900/50">
<div className="max-w-6xl mx-auto">
<h2 className="text-3xl font-bold text-center text-white mb-4">Tout ce dont vous avez besoin</h2>
<p className="text-surface-400 text-center mb-12 max-w-2xl mx-auto">Des outils puissants pour gÃ©rer efficacement la trÃ©sorerie de votre entreprise</p>
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
{features.map((f,i)=>(<div key={i} className="glass rounded-2xl p-6 hover:border-primary-500/50 transition-all hover:-translate-y-1">
<div className="w-14 h-14 gradient-primary rounded-xl flex items-center justify-center text-2xl mb-4">{f.icon}</div>
<h3 className="text-lg font-bold text-white mb-2">{f.title}</h3>
<p className="text-surface-400">{f.desc}</p>
</div>))}
</div>
</div>
</section>

{/* Pricing */}
<section className="py-20 px-4" id="pricing">
<div className="max-w-6xl mx-auto">
<h2 className="text-3xl font-bold text-center text-white mb-4">Tarifs simples et transparents</h2>
<p className="text-surface-400 text-center mb-12">Choisissez le plan adaptÃ© Ã  vos besoins</p>
<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
{Object.entries(PLANS).map(([key,plan])=>(<div key={key} className={cn('glass rounded-3xl overflow-hidden transition-all hover:shadow-2xl',key==='standard'?'ring-2 ring-primary-500 relative':'')}>
{key==='standard'&&<div className="absolute top-4 right-4 bg-primary-500 text-white text-xs font-bold px-3 py-1 rounded-full">POPULAIRE</div>}
<div className={cn('p-6 text-white',plan.gradient)}>
<div className="flex justify-between items-start">
<div><p className="text-white/80 text-sm">Plan</p><h3 className="text-2xl font-bold">{plan.nom}</h3></div>
<span className="text-4xl">{plan.icon}</span>
</div>
<div className="mt-4">
<span className="text-4xl font-bold">{plan.prix>0?fmt(plan.prix):'Gratuit'}</span>
{plan.prix>0&&<span className="text-white/80 ml-2">FCFA/{plan.duree}</span>}
</div>
</div>
<div className="p-6">
<ul className="space-y-3">{plan.features.map((f,i)=><li key={i} className="flex items-center gap-3 text-surface-300"><span className="w-5 h-5 bg-primary-500/20 text-primary-400 rounded-full flex items-center justify-center text-xs">âœ“</span>{f}</li>)}</ul>
<button onClick={onGoRegister} className={cn('w-full mt-6 py-3 rounded-xl font-bold transition-all',key==='trial'?'bg-surface-700 text-surface-300 hover:bg-surface-600':'gradient-primary text-white hover:shadow-lg')}>
{key==='trial'?'Essayer gratuitement':'Commencer'}
</button>
</div>
</div>))}
</div>
</div>
</section>

{/* CTA */}
<section className="py-20 px-4">
<div className="max-w-4xl mx-auto">
<div className="glass rounded-3xl p-8 md:p-12 text-center border-2 border-primary-500/30">
<h2 className="text-3xl font-bold text-white mb-4">PrÃªt Ã  mieux gÃ©rer votre trÃ©sorerie ?</h2>
<p className="text-surface-400 mb-8">Rejoignez des centaines d'entreprises qui font confiance Ã  Qashora</p>
<button onClick={onGoRegister} className="px-8 py-4 gradient-primary text-white rounded-xl font-bold text-lg hover:shadow-xl hover:shadow-primary-500/30 transition-all">
ğŸš€ CrÃ©er mon compte gratuit
</button>
</div>
</div>
</section>

{/* Footer */}
<footer className="py-8 px-4 border-t border-surface-800">
<div className="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
<div className="flex items-center gap-2">
<div className="w-8 h-8 gradient-primary rounded-lg flex items-center justify-center text-white font-bold">Q</div>
<span className="font-bold text-surface-300">Qashora</span>
</div>
<p className="text-surface-500 text-sm">Â© 2025 Qashora. Tous droits rÃ©servÃ©s.</p>
<div className="flex items-center gap-4">
<a href={`https://wa.me/${WHATSAPP_CONTACT.replace('+','')}`} target="_blank" className="text-surface-400 hover:text-emerald-400 transition-colors">ğŸ“± WhatsApp</a>
<a href="mailto:contact@qashora.com" className="text-surface-400 hover:text-primary-400 transition-colors">ğŸ“§ Contact</a>
</div>
</div>
</footer>
</div>);
};

// ===== PAGE D'INSCRIPTION =====
const RegisterPage=({onGoLogin,onNeedConfirmation})=>{
const[step,setStep]=useState(1);
const[loading,setLoading]=useState(false);
const[error,setError]=useState('');
const[form,setForm]=useState({
organisation:'',
nom:'',
prenom:'',
email:'',
password:'',
confirmPassword:''
});

const handleChange=(field,value)=>setForm(prev=>({...prev,[field]:value}));

const validateStep1=()=>{
if(!form.organisation.trim()){setError('Le nom de l\'organisation est requis');return false;}
if(form.organisation.length<2){setError('Le nom doit faire au moins 2 caractÃ¨res');return false;}
setError('');return true;
};

const validateStep2=()=>{
if(!form.nom.trim()||!form.prenom.trim()){setError('Nom et prÃ©nom sont requis');return false;}
if(!form.email.trim()||!form.email.includes('@')){setError('Email invalide');return false;}
if(form.password.length<6){setError('Mot de passe: minimum 6 caractÃ¨res');return false;}
if(form.password!==form.confirmPassword){setError('Les mots de passe ne correspondent pas');return false;}
setError('');return true;
};

const handleSubmit=async()=>{
if(!validateStep2())return;
setLoading(true);setError('');
try{
// 1. CrÃ©er le compte avec Supabase Auth
const{data:authData,error:authError}=await supabase.auth.signUp({
email:form.email.toLowerCase().trim(),
password:form.password,
options:{
data:{
prenom:form.prenom,
nom:form.nom,
organisation:form.organisation
}
}
});
if(authError)throw authError;

// 2. CrÃ©er l'organisation
const{data:org,error:orgError}=await supabase.from('organisations').insert([{
nom:form.organisation.trim(),
created_at:new Date().toISOString()
}]).select().single();
if(orgError)throw orgError;

// 3. CrÃ©er l'utilisateur dans notre table
const{data:user,error:userError}=await supabase.from('utilisateurs').insert([{
organisation_id:org.id,
auth_id:authData.user?.id,
username:`${form.prenom} ${form.nom}`,
email:form.email.toLowerCase().trim(),
role:'Admin',
actif:true,
email_confirmed:false,
created_at:new Date().toISOString()
}]).select().single();
if(userError)throw userError;

// 4. CrÃ©er l'abonnement essai (14 jours)
const dateFin=new Date();dateFin.setDate(dateFin.getDate()+14);
await supabase.from('abonnements').insert([{
organisation_id:org.id,
user_id:user.id,
plan:'trial',
statut:'actif',
date_debut:new Date().toISOString(),
date_fin:dateFin.toISOString(),
montant:0
}]);

// 5. CrÃ©er les paramÃ¨tres par dÃ©faut pour cette organisation
const defaultParams=[
{organisation_id:org.id,type:'pays',valeur:'SÃ©nÃ©gal'},
{organisation_id:org.id,type:'pays',valeur:'CÃ´te d\'Ivoire'},
{organisation_id:org.id,type:'pays',valeur:'Mali'},
{organisation_id:org.id,type:'nature',valeur:'Virement'},
{organisation_id:org.id,type:'nature',valeur:'ChÃ¨que'},
{organisation_id:org.id,type:'nature',valeur:'EspÃ¨ces'},
{organisation_id:org.id,type:'statut',valeur:'ValidÃ©'},
{organisation_id:org.id,type:'statut',valeur:'En attente'},
{organisation_id:org.id,type:'statut',valeur:'AnnulÃ©'}
];
await supabase.from('parametres').insert(defaultParams);

// SuccÃ¨s - Afficher page confirmation email
onNeedConfirmation(form.email);
}catch(e){
console.error(e);
if(e.message?.includes('already registered')){
setError('Cet email est dÃ©jÃ  utilisÃ©');
}else{
setError(e.message||'Erreur lors de l\'inscription');
}
}
setLoading(false);
};

return(<div className="min-h-screen bg-surface-950 flex items-center justify-center p-4">
<div className="w-full max-w-md">
{/* Logo */}
<div className="text-center mb-8">
<div className="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg mx-auto mb-4 animate-glow">Q</div>
<h1 className="text-2xl font-bold text-white">CrÃ©er votre compte</h1>
<p className="text-surface-400 mt-2">Commencez avec 14 jours d'essai gratuit</p>
</div>

{/* Progress */}
<div className="flex items-center justify-center gap-2 mb-8">
<div className={cn('w-10 h-10 rounded-full flex items-center justify-center font-bold transition-all',step>=1?'gradient-primary text-white':'bg-surface-800 text-surface-500')}>1</div>
<div className={cn('w-16 h-1 rounded-full transition-all',step>=2?'gradient-primary':'bg-surface-800')}/>
<div className={cn('w-10 h-10 rounded-full flex items-center justify-center font-bold transition-all',step>=2?'gradient-primary text-white':'bg-surface-800 text-surface-500')}>2</div>
</div>

<div className="glass rounded-2xl p-6">
{error&&<div className="mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm">{error}</div>}

{step===1&&(<div className="space-y-4 animate-fade-in">
<div>
<label className="block text-sm font-bold text-surface-300 mb-2">ğŸ¢ Nom de votre organisation</label>
<input type="text" value={form.organisation} onChange={e=>handleChange('organisation',e.target.value)} placeholder="Ex: Ma SociÃ©tÃ© SARL" className="w-full px-4 py-3 bg-surface-800 border border-surface-600 rounded-xl text-white placeholder-surface-500 focus:border-primary-500"/>
<p className="text-xs text-surface-500 mt-2">Le nom de votre entreprise ou organisation</p>
</div>
<button onClick={()=>{if(validateStep1())setStep(2);}} className="w-full py-3 gradient-primary text-white rounded-xl font-bold hover:shadow-lg transition-all">
Continuer â†’
</button>
</div>)}

{step===2&&(<div className="space-y-4 animate-fade-in">
<div className="grid grid-cols-2 gap-3">
<div>
<label className="block text-xs font-bold text-surface-300 mb-1.5">PrÃ©nom</label>
<input type="text" value={form.prenom} onChange={e=>handleChange('prenom',e.target.value)} placeholder="Jean" className="w-full px-4 py-3 bg-surface-800 border border-surface-600 rounded-xl text-white placeholder-surface-500 focus:border-primary-500"/>
</div>
<div>
<label className="block text-xs font-bold text-surface-300 mb-1.5">Nom</label>
<input type="text" value={form.nom} onChange={e=>handleChange('nom',e.target.value)} placeholder="Dupont" className="w-full px-4 py-3 bg-surface-800 border border-surface-600 rounded-xl text-white placeholder-surface-500 focus:border-primary-500"/>
</div>
</div>
<div>
<label className="block text-xs font-bold text-surface-300 mb-1.5">ğŸ“§ Email</label>
<input type="email" value={form.email} onChange={e=>handleChange('email',e.target.value)} placeholder="jean@exemple.com" className="w-full px-4 py-3 bg-surface-800 border border-surface-600 rounded-xl text-white placeholder-surface-500 focus:border-primary-500"/>
</div>
<div>
<label className="block text-xs font-bold text-surface-300 mb-1.5">ğŸ”’ Mot de passe</label>
<input type="password" value={form.password} onChange={e=>handleChange('password',e.target.value)} placeholder="Minimum 4 caractÃ¨res" className="w-full px-4 py-3 bg-surface-800 border border-surface-600 rounded-xl text-white placeholder-surface-500 focus:border-primary-500"/>
</div>
<div>
<label className="block text-xs font-bold text-surface-300 mb-1.5">ğŸ”’ Confirmer le mot de passe</label>
<input type="password" value={form.confirmPassword} onChange={e=>handleChange('confirmPassword',e.target.value)} placeholder="RÃ©pÃ©tez le mot de passe" className="w-full px-4 py-3 bg-surface-800 border border-surface-600 rounded-xl text-white placeholder-surface-500 focus:border-primary-500"/>
</div>
<div className="flex gap-3">
<button onClick={()=>setStep(1)} className="px-6 py-3 bg-surface-700 text-surface-300 rounded-xl font-bold hover:bg-surface-600 transition-all">
â† Retour
</button>
<button onClick={handleSubmit} disabled={loading} className="flex-1 py-3 gradient-primary text-white rounded-xl font-bold hover:shadow-lg transition-all disabled:opacity-50 flex items-center justify-center gap-2">
{loading?<><div className="loader" style={{width:20,height:20}}/>CrÃ©ation...</>:'ğŸš€ CrÃ©er mon compte'}
</button>
</div>
</div>)}
</div>

<p className="text-center text-surface-400 mt-6">
DÃ©jÃ  inscrit ? <button onClick={onGoLogin} className="text-primary-400 font-bold hover:underline">Se connecter</button>
</p>
</div>
</div>);
};

// ===== PAGE CONFIRMATION EMAIL =====
const ConfirmEmailPage=({email,onGoLogin})=>{
const[resending,setResending]=useState(false);
const[resent,setResent]=useState(false);

const handleResend=async()=>{
setResending(true);
try{
await supabase.auth.resend({type:'signup',email});
setResent(true);
setTimeout(()=>setResent(false),5000);
}catch(e){console.error(e);}
setResending(false);
};

return(<div className="min-h-screen bg-surface-950 flex items-center justify-center p-4">
<div className="w-full max-w-md text-center">
<div className="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
<span className="text-5xl">ğŸ“§</span>
</div>
<h1 className="text-2xl font-bold text-white mb-4">VÃ©rifiez votre email</h1>
<p className="text-surface-400 mb-2">Un email de confirmation a Ã©tÃ© envoyÃ© Ã  :</p>
<p className="text-primary-400 font-bold mb-6">{email}</p>
<div className="glass rounded-2xl p-6 text-left space-y-4">
<div className="flex items-start gap-3">
<span className="text-xl">1ï¸âƒ£</span>
<p className="text-surface-300">Ouvrez votre boÃ®te email</p>
</div>
<div className="flex items-start gap-3">
<span className="text-xl">2ï¸âƒ£</span>
<p className="text-surface-300">Cliquez sur le lien de confirmation</p>
</div>
<div className="flex items-start gap-3">
<span className="text-xl">3ï¸âƒ£</span>
<p className="text-surface-300">Revenez ici pour vous connecter</p>
</div>
</div>
<div className="mt-6 space-y-3">
{resent&&<p className="text-emerald-400 text-sm">âœ… Email renvoyÃ© !</p>}
<button onClick={handleResend} disabled={resending} className="text-surface-400 hover:text-primary-400 text-sm underline">
{resending?'Envoi en cours...':'Renvoyer l\'email'}
</button>
</div>
<button onClick={onGoLogin} className="mt-8 px-6 py-3 gradient-primary text-white rounded-xl font-bold hover:shadow-lg transition-all">
J'ai confirmÃ© mon email â†’ Connexion
</button>
<p className="text-surface-500 text-xs mt-4">VÃ©rifiez aussi vos spams</p>
</div>
</div>);
};

// ===== UTILITAIRES =====
const fmt=n=>n?new Intl.NumberFormat('fr-FR').format(Math.round(n)):'0';
const fmtD=s=>s?new Date(s).toLocaleDateString('fr-FR'):'';
const parse=s=>parseFloat(String(s||'').replace(/\s/g,'').replace(/,/g,'.'))||0;
const cn=(...c)=>c.filter(Boolean).join(' ');

// ===== FILTRES PÃ‰RIODE =====
const getPeriodDates=(period)=>{const now=new Date();const y=now.getFullYear();const m=now.getMonth();const d=now.getDate();
switch(period){case'today':return{d1:new Date(y,m,d).toISOString().split('T')[0],d2:new Date(y,m,d).toISOString().split('T')[0]};
case'week':const w=new Date(now);w.setDate(d-now.getDay()+1);return{d1:w.toISOString().split('T')[0],d2:now.toISOString().split('T')[0]};
case'month':return{d1:new Date(y,m,1).toISOString().split('T')[0],d2:new Date(y,m+1,0).toISOString().split('T')[0]};
case'quarter':const q=Math.floor(m/3)*3;return{d1:new Date(y,q,1).toISOString().split('T')[0],d2:new Date(y,q+3,0).toISOString().split('T')[0]};
case'year':return{d1:new Date(y,0,1).toISOString().split('T')[0],d2:new Date(y,11,31).toISOString().split('T')[0]};
case'lastMonth':return{d1:new Date(y,m-1,1).toISOString().split('T')[0],d2:new Date(y,m,0).toISOString().split('T')[0]};
case'lastQuarter':const lq=Math.floor(m/3)*3-3;return{d1:new Date(y,lq,1).toISOString().split('T')[0],d2:new Date(y,lq+3,0).toISOString().split('T')[0]};
default:return{d1:'',d2:''};}};

// ===== COMPOSANTS UI =====
const Loader=({text,size='md'})=>{const s={sm:{w:16,h:16},md:{w:24,h:24},lg:{w:32,h:32}};return(<div className="flex flex-col items-center justify-center py-8"><div className="loader" style={{width:s[size].w,height:s[size].h}}></div>{text&&<p className="text-surface-400 text-sm mt-3">{text}</p>}</div>);};
const Button=({children,onClick,variant='primary',disabled,className='',icon,type='button',size='md',loading})=>{const v={primary:'btn-primary text-white',secondary:'bg-surface-700 hover:bg-surface-600 text-surface-100 border border-surface-600',danger:'bg-red-600 hover:bg-red-500 text-white',ghost:'bg-transparent hover:bg-surface-700 text-surface-400',success:'bg-emerald-600 hover:bg-emerald-500 text-white'};const sz={sm:'px-3 py-1.5 text-xs',md:'px-4 py-2 text-sm',lg:'px-6 py-3 text-base'};return<button type={type} onClick={onClick} disabled={disabled||loading} className={cn('inline-flex items-center justify-center gap-2 font-semibold rounded-xl transition-all',v[variant],sz[size],(disabled||loading)&&'opacity-50 cursor-not-allowed',className)}>{loading?<div className="loader" style={{width:16,height:16,borderWidth:2}}></div>:icon}{children}</button>;};
const Input=({label,type='text',value,onChange,placeholder,disabled,error,className='',required,icon})=>(<div className={className}>{label&&<label className="block text-xs font-bold text-surface-300 mb-1.5">{label}{required&&<span className="text-red-400 ml-1">*</span>}</label>}<div className="relative">{icon&&<span className="absolute left-3 top-1/2 -translate-y-1/2 text-surface-400">{icon}</span>}<input type={type} value={value} onChange={onChange} placeholder={placeholder} disabled={disabled} className={cn('w-full px-3 py-2.5 bg-surface-800 border rounded-xl text-surface-100 placeholder-surface-500 text-sm',icon&&'pl-10',error?'border-red-500':'border-surface-600',disabled&&'opacity-50')}/></div>{error&&<p className="mt-1 text-xs text-red-400">{error}</p>}</div>);
const Select=({label,value,onChange,options,placeholder,disabled,className='',required})=>(<div className={className}>{label&&<label className="block text-xs font-bold text-surface-300 mb-1.5">{label}{required&&<span className="text-red-400 ml-1">*</span>}</label>}<select value={value} onChange={onChange} disabled={disabled} className={cn('w-full px-3 py-2.5 bg-surface-800 border border-surface-600 rounded-xl text-surface-100 text-sm',disabled&&'opacity-50')}>{placeholder&&<option value="">{placeholder}</option>}{options.map((o,i)=><option key={i} value={typeof o==='object'?o.value:o}>{typeof o==='object'?o.label:o}</option>)}</select></div>);
const Modal=({isOpen,onClose,title,children,size='md'})=>{if(!isOpen)return null;const s={sm:'max-w-md',md:'max-w-2xl',lg:'max-w-4xl',xl:'max-w-6xl'};return(<div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in" onClick={onClose}><div className={cn('glass rounded-2xl w-full shadow-2xl max-h-[85vh] overflow-hidden animate-scale-in my-auto',s[size])} onClick={e=>e.stopPropagation()}><div className="sticky top-0 z-10 flex items-center justify-between px-6 py-4 border-b border-surface-700 bg-surface-900/95"><h3 className="text-lg font-bold text-surface-100">{title}</h3><button onClick={onClose} className="w-8 h-8 rounded-lg bg-surface-700 hover:bg-red-500/20 hover:text-red-400 flex items-center justify-center transition-colors">âœ•</button></div><div className="p-6 overflow-y-auto max-h-[calc(85vh-80px)]">{children}</div></div></div>);};
const StatCard=({icon,label,value,subvalue,gradient,onClick})=>(<div onClick={onClick} className={cn('stat-card relative overflow-hidden rounded-2xl p-5 shadow-lg',gradient,onClick&&'cursor-pointer')}><div className="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -translate-y-6 translate-x-6"/><div className="relative z-10"><span className="text-2xl">{icon}</span><p className="text-white/70 text-sm mt-3">{label}</p><p className="text-xl font-bold text-white font-mono mt-1">{value}</p>{subvalue&&<p className="text-white/50 text-xs mt-1">{subvalue}</p>}</div></div>);
const Badge=({children,variant='default'})=>{const v={default:'bg-surface-600 text-surface-200',success:'bg-emerald-500/20 text-emerald-400',warning:'bg-amber-500/20 text-amber-400',danger:'bg-red-500/20 text-red-400',info:'bg-secondary-500/20 text-secondary-400'};return<span className={cn('inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded',v[variant])}>{children}</span>;};
const Alert=({type='info',message,onClose})=>{const t={info:'bg-blue-500/10 text-blue-400 border-blue-500/30',success:'bg-emerald-500/10 text-emerald-400 border-emerald-500/30',error:'bg-red-500/10 text-red-400 border-red-500/30',warning:'bg-amber-500/10 text-amber-400 border-amber-500/30'};const ic={info:'â„¹ï¸',success:'âœ…',error:'âŒ',warning:'âš ï¸'};return<div className={cn('px-4 py-3 rounded-xl border flex items-center gap-2 animate-fade-in',t[type])}><span>{ic[type]}</span><span className="text-sm font-medium flex-1">{message}</span>{onClose&&<button onClick={onClose} className="hover:opacity-70">âœ•</button>}</div>;};
const Empty=({icon,title,desc,action})=>(<div className="text-center py-12"><div className="text-5xl mb-4">{icon}</div><h3 className="text-lg font-bold text-surface-200 mb-2">{title}</h3><p className="text-surface-400 text-sm mb-4">{desc}</p>{action}</div>);
const Tabs=({tabs,active,onChange})=>(<div className="flex gap-2 flex-wrap border-b border-surface-700 pb-3">{tabs.map(t=><button key={t.id} onClick={()=>onChange(t.id)} className={cn('px-4 py-2 rounded-lg text-sm font-bold transition-all',active===t.id?'gradient-primary text-white shadow-lg':'text-surface-400 hover:bg-surface-800')}>{t.icon} {t.label} {t.count!==undefined&&`(${t.count})`}</button>)}</div>);

// ===== COMPOSANT CHART =====
const ChartC=({type,data,title,options={}})=>{const ref=useRef(null);const inst=useRef(null);useEffect(()=>{if(ref.current){if(inst.current)inst.current.destroy();inst.current=new Chart(ref.current.getContext('2d'),{type,data,options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{family:'Plus Jakarta Sans'}}}},scales:type!=='doughnut'&&type!=='pie'?{x:{ticks:{color:'#64748b'},grid:{color:'rgba(71,85,105,0.3)'}},y:{ticks:{color:'#64748b'},grid:{color:'rgba(71,85,105,0.3)'}}}:undefined,...options}});}return()=>{if(inst.current)inst.current.destroy();};},[type,data,options]);return(<div className="glass rounded-xl p-4"><h3 className="text-sm font-bold text-surface-200 mb-3 flex items-center gap-2">ğŸ“Š {title}</h3><div className="chart-container"><canvas ref={ref}/></div></div>);};

// ===== NOTIFICATION TOAST =====
const Toast=({message,type='info',onClose})=>{useEffect(()=>{const t=setTimeout(onClose,4000);return()=>clearTimeout(t);},[onClose]);const bg={info:'bg-blue-600',success:'bg-emerald-600',error:'bg-red-600',warning:'bg-amber-600'};return(<div className={cn('fixed bottom-4 right-4 z-50 px-4 py-3 rounded-xl text-white shadow-2xl animate-slide-in flex items-center gap-3',bg[type])}><span>{message}</span><button onClick={onClose} className="hover:opacity-70">âœ•</button></div>);};

// ===== HOOK DONNÃ‰ES SUPABASE =====
const useData=(organisationId)=>{
    const[banques,setBanques]=useState([]);
    const[trans,setTrans]=useState([]);
    const[users,setUsers]=useState([]);
    const[params,setParams]=useState({pays:[],natures:[],statuts:[]});
    const[abonnement,setAbonnement]=useState(null);
    const[loading,setLoading]=useState(true);
    const[error,setError]=useState(null);

    const loadAll=async()=>{
        if(!organisationId){setLoading(false);return;}
        setLoading(true);
        try{
            const[bRes,tRes,uRes,pRes,aRes]=await Promise.all([
                supabase.from('banques').select('*').eq('organisation_id',organisationId).eq('actif',true).order('nom'),
                supabase.from('transactions').select('*').eq('organisation_id',organisationId).order('date',{ascending:false}),
                supabase.from('utilisateurs').select('*').eq('organisation_id',organisationId).eq('actif',true),
                supabase.from('parametres').select('*').eq('organisation_id',organisationId).eq('actif',true).order('ordre'),
                supabase.from('abonnements').select('*').eq('organisation_id',organisationId).order('created_at',{ascending:false}).limit(1)
            ]);
            if(bRes.error)throw bRes.error;
            if(tRes.error)throw tRes.error;
            if(uRes.error)throw uRes.error;
            if(pRes.error)throw pRes.error;
            setBanques(bRes.data||[]);
            setTrans((tRes.data||[]).map(t=>({...t,banqueId:t.banque_id,banqueNom:t.banque_nom,noCheque:t.no_cheque,sectionDem:t.section_demandeur,sectionBen:t.section_beneficiaire,centre:t.centre_interet,bDebit:t.banque_debit,bCredit:t.banque_credit,deletedAt:t.deleted_at,deletedBy:t.deleted_by})));
            setUsers(uRes.data||[]);
            const p={pays:[],natures:[],statuts:[]};
            (pRes.data||[]).forEach(x=>{if(x.type==='pays')p.pays.push(x.valeur);else if(x.type==='nature')p.natures.push(x.valeur);else if(x.type==='statut')p.statuts.push(x.valeur);});
            setParams(p);
            // Abonnement
            if(aRes.data&&aRes.data.length>0){const abo=aRes.data[0];const isExpire=abo.date_fin?new Date(abo.date_fin)<new Date():false;setAbonnement({...abo,isExpire,plan:isExpire?'trial':abo.plan});}
            else{const dateFin=new Date();dateFin.setDate(dateFin.getDate()+14);setAbonnement({plan:'trial',date_fin:dateFin.toISOString(),isExpire:false});}
        }catch(e){console.error(e);setError(e.message);}
        setLoading(false);
    };

    useEffect(()=>{loadAll();},[organisationId]);

    // BANQUES - avec organisation_id
    const addBanque=async(d)=>{const{data,error}=await supabase.from('banques').insert([{organisation_id:organisationId,nom:d.nom,numero_compte:d.numeroCompte,gestionnaire:d.gestionnaire,contact:d.contact,pays:d.pays,solde_ouverture:d.soldeOuverture||0}]).select();if(error)throw error;await loadAll();return data;};
    const updateBanque=async(id,d)=>{const{error}=await supabase.from('banques').update({nom:d.nom,numero_compte:d.numeroCompte,gestionnaire:d.gestionnaire,contact:d.contact,pays:d.pays,solde_ouverture:d.soldeOuverture||0}).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};
    const deleteBanque=async(id)=>{const{error}=await supabase.from('banques').update({actif:false}).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};

    // TRANSACTIONS - avec organisation_id
    const addTrans=async(d)=>{const{data,error}=await supabase.from('transactions').insert([{organisation_id:organisationId,date:d.date,banque_id:d.banqueId,banque_nom:d.banqueNom,pays:d.pays,projet:d.projet,no_cheque:d.noCheque,demandeur:d.demandeur,section_demandeur:d.sectionDem,nature:d.nature,designation:d.designation,beneficiaire:d.beneficiaire,section_beneficiaire:d.sectionBen,debit:d.debit||0,credit:d.credit||0,centre_interet:d.centre,statut:d.statut,banque_debit:d.bDebit||0,banque_credit:d.bCredit||0,created_by:d.createdBy}]).select();if(error)throw error;await loadAll();return data;};
    const updateTrans=async(id,d)=>{const{error}=await supabase.from('transactions').update({date:d.date,banque_id:d.banqueId,banque_nom:d.banqueNom,pays:d.pays,projet:d.projet,no_cheque:d.noCheque,demandeur:d.demandeur,section_demandeur:d.sectionDem,nature:d.nature,designation:d.designation,beneficiaire:d.beneficiaire,section_beneficiaire:d.sectionBen,debit:d.debit||0,credit:d.credit||0,centre_interet:d.centre,statut:d.statut,banque_debit:d.bDebit||0,banque_credit:d.bCredit||0}).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};
    const deleteTrans=async(id,by)=>{const{error}=await supabase.from('transactions').update({deleted_at:new Date().toISOString(),deleted_by:by}).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};
    const restoreTrans=async(id)=>{const{error}=await supabase.from('transactions').update({deleted_at:null,deleted_by:null}).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};
    const permDeleteTrans=async(id)=>{const{error}=await supabase.from('transactions').delete().eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};

    // USERS - avec organisation_id
    const addUser=async(d)=>{const{data,error}=await supabase.from('utilisateurs').insert([{organisation_id:organisationId,username:d.username,email:d.email,role:d.role,password:d.password}]).select();if(error)throw error;await loadAll();return data;};
    const updateUser=async(id,d)=>{const upd={username:d.username,email:d.email,role:d.role};if(d.password)upd.password=d.password;const{error}=await supabase.from('utilisateurs').update(upd).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};
    const deleteUser=async(id)=>{const{error}=await supabase.from('utilisateurs').update({actif:false}).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};
    const resetPassword=async(id,newPwd)=>{const{error}=await supabase.from('utilisateurs').update({password:newPwd}).eq('id',id).eq('organisation_id',organisationId);if(error)throw error;await loadAll();};

    // PARAMETRES - avec organisation_id
    const addParam=async(type,valeur)=>{
        const key=type==='nature'?'natures':type==='statut'?'statuts':'pays';
        const max=params[key]?.length||0;
        const{error}=await supabase.from('parametres').insert([{organisation_id:organisationId,type,valeur,ordre:max+1,actif:true}]);
        if(error)throw error;
        await loadAll();
    };
    const updateParam=async(type,oldVal,newVal)=>{
        const{error}=await supabase.from('parametres').update({valeur:newVal}).eq('type',type).eq('valeur',oldVal).eq('organisation_id',organisationId);
        if(error)throw error;
        await loadAll();
    };
    const deleteParam=async(type,valeur)=>{
        const{error}=await supabase.from('parametres').delete().eq('type',type).eq('valeur',valeur).eq('organisation_id',organisationId);
        if(error)throw error;
        await loadAll();
    };

    // Fonctions abonnement
    const getPlanLimites=()=>PLANS[abonnement?.plan||'trial']?.limites||PLANS.trial.limites;
    const checkLimite=(type,count)=>{const lim=getPlanLimites();return lim[type]===999||count<lim[type];};
    const canExportPDF=()=>getPlanLimites().exportPDF;
    const getJoursRestants=()=>{if(!abonnement?.date_fin)return 0;const diff=new Date(abonnement.date_fin)-new Date();return Math.max(0,Math.ceil(diff/(1000*60*60*24)));};

    return{banques,trans,users,params,abonnement,loading,error,reload:loadAll,addBanque,updateBanque,deleteBanque,addTrans,updateTrans,deleteTrans,restoreTrans,permDeleteTrans,addUser,updateUser,deleteUser,resetPassword,addParam,updateParam,deleteParam,getPlanLimites,checkLimite,canExportPDF,getJoursRestants};
};

// ===== PAGE LOGIN =====
const Login=({onLogin,onGoRegister,onGoLanding})=>{
const[email,setEmail]=useState('');
const[password,setPassword]=useState('');
const[error,setError]=useState('');
const[loading,setLoading]=useState(false);

const handleSubmit=async(ev)=>{
ev.preventDefault();
setError('');
if(!email||!password){setError('Veuillez remplir tous les champs');return;}
setLoading(true);

try{
// 1. Connexion avec Supabase Auth
const{data:authData,error:authError}=await supabase.auth.signInWithPassword({
email:email.toLowerCase().trim(),
password
});

if(authError){
if(authError.message.includes('Email not confirmed')){
setError('Veuillez confirmer votre email avant de vous connecter. VÃ©rifiez votre boÃ®te mail.');
}else if(authError.message.includes('Invalid login')){
setError('Email ou mot de passe incorrect');
}else{
setError(authError.message);
}
setLoading(false);
return;
}

// 2. RÃ©cupÃ©rer l'utilisateur depuis notre table
const{data:user,error:userError}=await supabase
.from('utilisateurs')
.select('*')
.eq('auth_id',authData.user.id)
.single();

if(userError||!user){
// Peut-Ãªtre ancien utilisateur sans auth_id, chercher par email
const{data:userByEmail}=await supabase
.from('utilisateurs')
.select('*')
.eq('email',email.toLowerCase().trim())
.single();

if(userByEmail){
// Mettre Ã  jour auth_id
await supabase.from('utilisateurs').update({auth_id:authData.user.id,email_confirmed:true}).eq('id',userByEmail.id);
onLogin({...userByEmail,auth_id:authData.user.id});
}else{
setError('Compte non trouvÃ©');
setLoading(false);
return;
}
}else{
// Mettre Ã  jour email_confirmed si nÃ©cessaire
if(!user.email_confirmed){
await supabase.from('utilisateurs').update({email_confirmed:true}).eq('id',user.id);
}
onLogin(user);
}
}catch(e){
console.error(e);
setError('Erreur de connexion');
}
setLoading(false);
};

return(<div className="min-h-screen flex items-center justify-center relative overflow-hidden p-4">
<div className="absolute top-1/4 -left-20 w-96 h-96 bg-primary-500/20 rounded-full blur-3xl"/>
<div className="absolute bottom-1/4 -right-20 w-96 h-96 bg-secondary-500/20 rounded-full blur-3xl"/>
<div className="relative z-10 w-full max-w-md">
<div className="glass rounded-3xl p-6 md:p-8 animate-fade-in">
<div className="text-center mb-8">
<div className="inline-flex items-center justify-center w-16 md:w-20 h-16 md:h-20 gradient-primary rounded-2xl mb-4 animate-glow text-white shadow-lg shadow-primary-500/30">
<span className="text-2xl md:text-3xl font-bold">Q</span>
</div>
<h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-primary-400 to-secondary-400 bg-clip-text text-transparent">Qashora</h1>
<p className="text-surface-400 mt-2 text-sm md:text-base">Gestion de TrÃ©sorerie</p>
</div>
<form onSubmit={handleSubmit} className="space-y-5">
{error&&<Alert type="error" message={error}/>}
<Input label="Email" type="email" value={email} onChange={ev=>setEmail(ev.target.value)} placeholder="votre@email.com" required/>
<Input label="Mot de passe" type="password" value={password} onChange={ev=>setPassword(ev.target.value)} placeholder="Votre mot de passe" required/>
<Button type="submit" className="w-full" size="lg" loading={loading}>{loading?'Connexion...':'ğŸ” Se connecter'}</Button>
</form>
<div className="mt-6 pt-6 border-t border-surface-700 text-center">
<p className="text-surface-400 text-sm">Pas encore de compte ?</p>
<button onClick={onGoRegister} className="text-primary-400 font-bold hover:underline mt-1">CrÃ©er un compte gratuitement</button>
</div>
</div>
<button onClick={onGoLanding} className="w-full text-center text-surface-500 text-sm mt-4 hover:text-surface-300">â† Retour Ã  l'accueil</button>
</div>
</div>);
};

// ===== SIDEBAR RESPONSIVE =====
const Side=({page,nav,user,logout,isOpen,toggle,isSuperAdmin})=>{
const items=[{id:'dashboard',label:'Tableau de bord',icon:'ğŸ“Š'},{id:'transactions',label:'Transactions',icon:'ğŸ“‹'},{id:'soldes',label:'Soldes',icon:'ğŸ¦'},...(user?.role==='Admin'?[{id:'users',label:'Utilisateurs',icon:'ğŸ‘¥'},{id:'corbeille',label:'Corbeille',icon:'ğŸ—‘ï¸'}]:[]),{id:'abonnement',label:'Abonnement',icon:'ğŸ’'},{id:'settings',label:'ParamÃ¨tres',icon:'âš™ï¸'},...(isSuperAdmin?[{id:'admin',label:'Admin',icon:'ğŸ›¡ï¸'}]:[])];
const roleInfo=ROLES[user?.role]||ROLES.User;
return(<><div className="md:hidden fixed top-0 left-0 right-0 h-16 bg-surface-900/95 backdrop-blur-xl border-b border-surface-800 z-50 flex items-center justify-between px-4"><button onClick={toggle} className="p-2 hover:bg-surface-800 rounded-lg text-xl">â˜°</button><div className="flex items-center gap-2"><div className="w-8 h-8 gradient-primary rounded-lg flex items-center justify-center text-white font-bold">Q</div><span className="font-bold text-surface-100">Qashora</span></div><div className="w-8"/></div>
{isOpen&&<div className="md:hidden fixed inset-0 bg-black/50 z-40" onClick={toggle}/>}
<aside className={cn('sidebar fixed left-0 top-0 h-screen w-64 bg-surface-900/95 backdrop-blur-xl border-r border-surface-800 flex flex-col z-50 transition-transform md:translate-x-0',isOpen?'open':'')}>
<div className="p-6 border-b border-surface-800"><div className="flex items-center gap-3"><div className="w-11 h-11 gradient-primary rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg animate-glow">Q</div><div><h1 className="text-xl font-bold bg-gradient-to-r from-primary-400 to-secondary-400 bg-clip-text text-transparent">Qashora</h1><p className="text-xs text-surface-500">v3.0</p></div></div></div>
<nav className="flex-1 p-4 space-y-1 overflow-y-auto">{items.map(i=>(<button key={i.id} onClick={()=>{nav(i.id);toggle?.();}} className={cn('nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all relative',page===i.id?'bg-gradient-to-r from-primary-600/20 to-secondary-600/20 text-primary-400 border border-primary-500/30':'text-surface-400 hover:bg-surface-800 hover:text-surface-200')}><span className="text-lg">{i.icon}</span><span className="font-medium">{i.label}</span></button>))}</nav>
<div className="p-4 border-t border-surface-800"><div className="flex items-center gap-3 mb-3"><div className="w-10 h-10 rounded-full gradient-primary flex items-center justify-center text-white font-bold">{user?.username?.charAt(0).toUpperCase()}</div><div className="flex-1 min-w-0"><p className="text-sm font-medium text-surface-200 truncate">{user?.username}</p><p className="text-xs text-surface-500 flex items-center gap-1"><span>{roleInfo.icon}</span>{roleInfo.label}</p></div></div><Button variant="ghost" className="w-full justify-start" onClick={logout} icon="ğŸšª">DÃ©connexion</Button></div></aside></>);};

// ===== PAGE DASHBOARD =====
const Dashboard=({trans,banques,onNavigate})=>{
const currentYear=new Date().getFullYear();
const years=useMemo(()=>{const ySet=new Set();trans.forEach(t=>{if(t.date)ySet.add(new Date(t.date).getFullYear());});return[...ySet].sort((a,b)=>b-a);},[trans]);
const[year,setYear]=useState(currentYear);
const[d1,setD1]=useState('');
const[d2,setD2]=useState('');

const filtered=useMemo(()=>{let a=trans.filter(t=>!t.deletedAt&&t.statut!=='AnnulÃ©');
if(d1&&d2){a=a.filter(t=>t.date>=d1&&t.date<=d2);}
else if(year){a=a.filter(t=>new Date(t.date).getFullYear()===year);}
return a;},[trans,year,d1,d2]);

const st=useMemo(()=>{const a=filtered;const deb=a.reduce((s,t)=>s+(parseFloat(t.debit)||0),0);const cre=a.reduce((s,t)=>s+(parseFloat(t.credit)||0),0);const sus=a.filter(t=>t.statut&&t.statut.includes('En attente'));const susD=sus.reduce((s,t)=>s+(parseFloat(t.debit)||0),0);const susC=sus.reduce((s,t)=>s+(parseFloat(t.credit)||0),0);
const sb={};banques.forEach(b=>{const bt=a.filter(t=>t.banqueNom===b.nom);const soldeOuv=parseFloat(b.solde_ouverture)||0;const mvt=(bt.reduce((s,t)=>s+(parseFloat(t.debit)||0),0))-(bt.reduce((s,t)=>s+(parseFloat(t.credit)||0),0));sb[b.nom]=soldeOuv+mvt;});
const md={};a.forEach(t=>{const m=new Date(t.date).toLocaleDateString('fr-FR',{month:'short'});if(!md[m])md[m]={d:0,c:0};md[m].d+=parseFloat(t.debit)||0;md[m].c+=parseFloat(t.credit)||0;});const bn={};a.forEach(t=>{if(!bn[t.nature])bn[t.nature]=0;bn[t.nature]+=(parseFloat(t.debit)||0)+(parseFloat(t.credit)||0);});
const totalSoldeOuv=banques.reduce((s,b)=>s+(parseFloat(b.solde_ouverture)||0),0);
return{deb,cre,sol:totalSoldeOuv+deb-cre,susN:susD-susC,susC:sus.length,cnt:a.length,sb,md,bn,totalSoldeOuv};},[filtered,banques]);

const bar=useMemo(()=>{const l=Object.keys(st.md).slice(-6);return{labels:l,datasets:[{label:'Encaiss.',data:l.map(x=>st.md[x]?.d||0),backgroundColor:'rgba(217,70,239,0.7)',borderRadius:6},{label:'DÃ©caiss.',data:l.map(x=>st.md[x]?.c||0),backgroundColor:'rgba(34,211,238,0.7)',borderRadius:6}]};},[st.md]);
const line=useMemo(()=>{const l=Object.keys(st.md).slice(-6);let c=st.totalSoldeOuv;return{labels:l,datasets:[{label:'Solde',data:l.map(x=>{c+=(st.md[x]?.d||0)-(st.md[x]?.c||0);return c;}),borderColor:'#d946ef',backgroundColor:'rgba(217,70,239,0.1)',fill:true,tension:0.4}]};},[st.md,st.totalSoldeOuv]);
const donut=useMemo(()=>({labels:Object.keys(st.bn),datasets:[{data:Object.values(st.bn),backgroundColor:['#d946ef','#22d3ee','#f59e0b','#10b981'],borderWidth:0}]}),[st.bn]);
const top=useMemo(()=>{const s=Object.entries(st.sb).filter(([_,v])=>v!==0).sort((a,b)=>Math.abs(b[1])-Math.abs(a[1])).slice(0,5);return{labels:s.map(([k])=>k.length>12?k.substring(0,12)+'..':k),datasets:[{label:'Solde',data:s.map(([_,v])=>v),backgroundColor:s.map(([_,v])=>v>=0?'rgba(16,185,129,0.7)':'rgba(239,68,68,0.7)'),borderRadius:6}]};},[st.sb]);

const resetFilters=()=>{setYear(currentYear);setD1('');setD2('');};
const applyDateRange=(from,to)=>{setD1(from);setD2(to);setYear(0);};

if(banques.length===0)return(<div className="animate-fade-in pt-16 md:pt-0"><div className="glass rounded-2xl p-8 text-center"><div className="text-6xl mb-4">ğŸ¦</div><h2 className="text-2xl font-bold text-surface-100 mb-2">Bienvenue sur Qashora !</h2><p className="text-surface-400 mb-6">Pour commencer, ajoutez vos banques dans les paramÃ¨tres.</p><Button onClick={()=>onNavigate('settings')} icon="âš™ï¸" size="lg">Configurer mes banques</Button></div></div>);

return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0">
<div className="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h1 className="text-2xl font-bold text-surface-100">Tableau de bord</h1><p className="text-surface-400 mt-1">Vue d'ensemble {d1&&d2?`du ${fmtD(d1)} au ${fmtD(d2)}`:year?`- AnnÃ©e ${year}`:''}</p></div><p className="text-surface-300 font-mono text-sm">{new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'})}</p></div>

<div className="glass rounded-xl p-4"><div className="flex flex-wrap items-end gap-3">
<div><label className="block text-xs font-bold text-surface-300 mb-1.5">AnnÃ©e</label><select value={year} onChange={e=>{setYear(parseInt(e.target.value));setD1('');setD2('');}} className="px-3 py-2 bg-surface-800 border border-surface-600 rounded-xl text-surface-100 text-sm"><option value={0}>Toutes</option>{years.map(y=><option key={y} value={y}>{y}</option>)}{!years.includes(currentYear)&&<option value={currentYear}>{currentYear}</option>}</select></div>
<div><label className="block text-xs font-bold text-surface-300 mb-1.5">Du</label><input type="date" value={d1} onChange={e=>applyDateRange(e.target.value,d2||e.target.value)} className="px-3 py-2 bg-surface-800 border border-surface-600 rounded-xl text-surface-100 text-sm"/></div>
<div><label className="block text-xs font-bold text-surface-300 mb-1.5">Au</label><input type="date" value={d2} onChange={e=>applyDateRange(d1||e.target.value,e.target.value)} className="px-3 py-2 bg-surface-800 border border-surface-600 rounded-xl text-surface-100 text-sm"/></div>
<Button variant="secondary" onClick={resetFilters} icon="ğŸ”„" size="sm">RÃ©init.</Button>
</div></div>

<div className="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4"><StatCard icon="ğŸ’°" label="Encaissements" value={fmt(st.deb)+' F'} gradient="gradient-primary"/><StatCard icon="ğŸ“¤" label="DÃ©caissements" value={fmt(st.cre)+' F'} gradient="gradient-secondary"/><StatCard icon="ğŸ“Š" label="Solde Net" value={fmt(st.sol)+' F'} subvalue={st.sol>=0?'ExcÃ©dent':'DÃ©ficit'} gradient={st.sol>=0?"gradient-success":"gradient-danger"}/><StatCard icon="â³" label="Suspens Net" value={fmt(st.susN)+' F'} subvalue={st.susC+' en attente'} gradient="gradient-warning" onClick={()=>onNavigate('transactions')}/><StatCard icon="ğŸ“‹" label="Transactions" value={st.cnt} subvalue="actives" gradient="gradient-indigo" onClick={()=>onNavigate('transactions')}/></div>
{filtered.length>0?(<><div className="grid grid-cols-1 lg:grid-cols-2 gap-5"><ChartC type="bar" data={bar} title="Ã‰volution Mensuelle"/><ChartC type="line" data={line} title="Solde CumulÃ©"/></div><div className="grid grid-cols-1 lg:grid-cols-3 gap-5"><ChartC type="doughnut" data={donut} title="Par Nature"/><div className="lg:col-span-2"><ChartC type="bar" data={top} title="Top Banques" options={{indexAxis:'y'}}/></div></div></>):(<div className="glass rounded-xl p-8 text-center"><p className="text-surface-400">Aucune transaction pour cette pÃ©riode.</p><Button onClick={()=>onNavigate('transactions')} className="mt-4" icon="â•">Nouvelle transaction</Button></div>)}
{Object.keys(st.sb).length>0&&(<div className="glass rounded-xl p-4"><h2 className="text-lg font-bold text-surface-100 mb-4">ğŸ¦ Soldes par Banque</h2><div className="grid grid-cols-2 md:grid-cols-4 gap-2">{Object.entries(st.sb).sort((a,b)=>Math.abs(b[1])-Math.abs(a[1])).map(([b,s])=>(<div key={b} className={cn('p-3 rounded-lg border',s>=0?'bg-emerald-500/10 border-emerald-500/30':'bg-red-500/10 border-red-500/30')}><p className="text-xs text-surface-400 truncate">{b}</p><p className={cn('text-base font-mono font-bold',s>=0?'text-emerald-400':'text-red-400')}>{fmt(s)}</p></div>))}</div></div>)}
</div>);};

// ===== EXPORT PDF =====
const exportPDF=(title,headers,rows,totals,filename)=>{
const{jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.setFontSize(18);doc.setTextColor(217,70,239);
doc.text(title,14,20);
doc.setFontSize(10);doc.setTextColor(100);
doc.text('GÃ©nÃ©rÃ© le '+new Date().toLocaleDateString('fr-FR')+' Ã  '+new Date().toLocaleTimeString('fr-FR'),14,28);
doc.autoTable({head:[headers],body:rows,foot:totals?[totals]:[],startY:35,theme:'grid',headStyles:{fillColor:[217,70,239],textColor:255,fontStyle:'bold'},footStyles:{fillColor:[30,41,59],textColor:[217,70,239],fontStyle:'bold'},styles:{fontSize:8,cellPadding:3},alternateRowStyles:{fillColor:[241,245,249]}});
doc.save(filename+'.pdf');
};

// ===== PAGE TRANSACTIONS =====
const Transactions=({data,user,showToast})=>{const{trans,banques,params,addTrans,updateTrans,deleteTrans}=data;const[show,setShow]=useState(false);const[edit,setEdit]=useState(null);const[f,setF]=useState({q:'',banque:'',nature:'',statut:'',d1:'',d2:'',period:''});const[sort,setSort]=useState({k:'date',d:'desc'});const[saving,setSaving]=useState(false);
const canCreate=canDo(user?.role,'create');const canEdit=canDo(user?.role,'update');const canDelete=canDo(user?.role,'delete');
const periods=[{value:'',label:'PÃ©riode...'},{value:'today',label:"Aujourd'hui"},{value:'week',label:'Cette semaine'},{value:'month',label:'Ce mois'},{value:'lastMonth',label:'Mois dernier'},{value:'quarter',label:'Ce trimestre'},{value:'lastQuarter',label:'Trimestre dernier'},{value:'year',label:'Cette annÃ©e'}];
const setPeriod=p=>{const dates=getPeriodDates(p);setF(x=>({...x,period:p,d1:dates.d1,d2:dates.d2}));};
const filtered=useMemo(()=>{let r=trans.filter(t=>!t.deletedAt);if(f.q){const s=f.q.toLowerCase();r=r.filter(t=>t.designation?.toLowerCase().includes(s)||t.beneficiaire?.toLowerCase().includes(s)||String(t.numero).includes(s));}if(f.banque)r=r.filter(t=>t.banqueNom===f.banque);if(f.nature)r=r.filter(t=>t.nature===f.nature);if(f.statut)r=r.filter(t=>t.statut===f.statut);if(f.d1)r=r.filter(t=>t.date>=f.d1);if(f.d2)r=r.filter(t=>t.date<=f.d2);r.sort((a,b)=>{let av=a[sort.k],bv=b[sort.k];if(sort.k==='date'){av=new Date(av);bv=new Date(bv);}if(av<bv)return sort.d==='asc'?-1:1;if(av>bv)return sort.d==='asc'?1:-1;return 0;});return r;},[trans,f,sort]);
const tot=useMemo(()=>{const a=filtered.filter(t=>t.statut!=='AnnulÃ©');return{d:a.reduce((s,t)=>s+(parseFloat(t.debit)||0),0),c:a.reduce((s,t)=>s+(parseFloat(t.credit)||0),0)};},[filtered]);
const doSort=k=>setSort(p=>({k,d:p.k===k&&p.d==='asc'?'desc':'asc'}));
const del=async t=>{if(confirm('Supprimer #'+t.numero+'?')){try{await deleteTrans(t.id,user?.username);showToast?.('Transaction supprimÃ©e','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}}};
const save=async d=>{setSaving(true);try{if(edit)await updateTrans(edit.id,d);else await addTrans({...d,createdBy:user?.username});setShow(false);setEdit(null);showToast?.(edit?'Transaction modifiÃ©e':'Transaction crÃ©Ã©e','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}setSaving(false);};
const expPDF=()=>{const headers=['Date','Banque','NÂ°','Nature','DÃ©signation','DÃ©bit','CrÃ©dit','Statut'];const rows=filtered.map(t=>[fmtD(t.date),t.banqueNom,t.numero,t.nature,t.designation?.substring(0,30)||'',fmt(t.debit),fmt(t.credit),t.statut]);const totals=['','','','','TOTAUX',fmt(tot.d),fmt(tot.c),'='+fmt(tot.d-tot.c)];exportPDF('Rapport des Transactions',headers,rows,totals,'transactions_'+new Date().toISOString().split('T')[0]);showToast?.('PDF gÃ©nÃ©rÃ©','success');};
const expCSV=()=>{const rows=[['Date','Banque','NÂ°','Nature','DÃ©signation','BÃ©nÃ©ficiaire','DÃ©bit','CrÃ©dit','Statut']];filtered.forEach(t=>rows.push([fmtD(t.date),t.banqueNom,t.numero,t.nature,t.designation,t.beneficiaire,t.debit,t.credit,t.statut]));const csv=rows.map(r=>r.join(';')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='transactions.csv';a.click();showToast?.('CSV exportÃ©','success');};
if(banques.length===0)return(<div className="animate-fade-in pt-16 md:pt-0"><Empty icon="ğŸ¦" title="Aucune banque configurÃ©e" desc="Ajoutez d'abord vos banques dans les paramÃ¨tres"/></div>);
return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0"><div className="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h1 className="text-2xl font-bold text-surface-100">Transactions</h1><p className="text-surface-400 mt-1">{filtered.length} rÃ©sultat(s)</p></div><div className="flex gap-2 flex-wrap">{canCreate&&<Button onClick={()=>{setEdit(null);setShow(true);}} icon="â•">Nouvelle</Button>}<Button variant="secondary" onClick={expPDF} icon="ğŸ“„">PDF</Button><Button variant="secondary" onClick={expCSV} icon="ğŸ“¥">CSV</Button></div></div>
<div className="glass rounded-xl p-4"><div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"><input type="text" placeholder="ğŸ” Rechercher..." value={f.q} onChange={e=>setF(p=>({...p,q:e.target.value}))} className="col-span-2 px-3 py-2.5 bg-surface-800 border border-surface-600 rounded-xl text-surface-100 text-sm"/><Select value={f.banque} onChange={e=>setF(p=>({...p,banque:e.target.value}))} options={banques.map(b=>b.nom)} placeholder="Banque"/><Select value={f.nature} onChange={e=>setF(p=>({...p,nature:e.target.value}))} options={params.natures} placeholder="Nature"/><Select value={f.statut} onChange={e=>setF(p=>({...p,statut:e.target.value}))} options={params.statuts} placeholder="Statut"/><Select value={f.period} onChange={e=>setPeriod(e.target.value)} options={periods.map(p=>({value:p.value,label:p.label}))}/><Button variant="secondary" onClick={()=>setF({q:'',banque:'',nature:'',statut:'',d1:'',d2:'',period:''})} icon="ğŸ”„" size="sm">RÃ©init.</Button></div><div className="grid grid-cols-2 gap-3 mt-3"><Input type="date" label="Du" value={f.d1} onChange={e=>setF(p=>({...p,d1:e.target.value,period:''}))}/><Input type="date" label="Au" value={f.d2} onChange={e=>setF(p=>({...p,d2:e.target.value,period:''}))}/></div></div>
{filtered.length===0?(<div className="glass rounded-xl p-8"><Empty icon="ğŸ“‹" title="Aucune transaction" desc={f.q||f.banque||f.nature||f.statut||f.d1?'Modifiez vos filtres':'CrÃ©ez votre premiÃ¨re transaction'} action={canCreate&&!f.q&&<Button onClick={()=>setShow(true)} icon="â•">Nouvelle transaction</Button>}/></div>):(<div className="glass rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-surface-800"><tr className="text-left text-xs text-surface-400">{[{k:'date',l:'Date'},{k:'banqueNom',l:'Banque'},{k:'numero',l:'NÂ°'},{k:'nature',l:'Nature'},{k:'designation',l:'DÃ©signation'},{k:'debit',l:'DÃ©bit'},{k:'credit',l:'CrÃ©dit'},{k:'statut',l:'Statut'}].map(c=>(<th key={c.k} className="px-3 md:px-4 py-3 cursor-pointer hover:text-surface-200 whitespace-nowrap" onClick={()=>doSort(c.k)}><div className="flex items-center gap-1">{c.l}{sort.k===c.k&&(sort.d==='asc'?'â†‘':'â†“')}</div></th>))}{(canEdit||canDelete)&&<th className="px-3 md:px-4 py-3">Act.</th>}</tr></thead><tbody className="divide-y divide-surface-800">{filtered.map(t=>(<tr key={t.id} className={cn('table-row',t.statut==='AnnulÃ©'&&'opacity-50')}><td className="px-3 md:px-4 py-3 font-mono text-surface-300 text-xs">{fmtD(t.date)}</td><td className="px-3 md:px-4 py-3 text-surface-200 max-w-[100px] truncate text-xs">{t.banqueNom}</td><td className="px-3 md:px-4 py-3 font-mono text-surface-400 text-xs">{t.numero}</td><td className="px-3 md:px-4 py-3"><Badge variant={t.nature==='Recette'?'success':t.nature==='DÃ©pense'?'info':'default'}>{t.nature}</Badge></td><td className="px-3 md:px-4 py-3 text-surface-300 max-w-[150px] truncate text-xs">{t.designation}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-emerald-400 text-xs">{t.debit&&parseFloat(t.debit)>0?fmt(t.debit):'-'}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-secondary-400 text-xs">{t.credit&&parseFloat(t.credit)>0?fmt(t.credit):'-'}</td><td className="px-3 md:px-4 py-3"><Badge variant={t.statut==='ConfirmÃ©'?'success':t.statut==='AnnulÃ©'?'danger':'warning'}>{t.statut?.substring(0,10)}</Badge></td>{(canEdit||canDelete)&&<td className="px-3 md:px-4 py-3"><div className="flex gap-1">{canEdit&&<button onClick={()=>{setEdit(t);setShow(true);}} className="p-1 hover:bg-surface-700 rounded text-surface-400 hover:text-primary-400">âœï¸</button>}{canDelete&&<button onClick={()=>del(t)} className="p-1 hover:bg-surface-700 rounded text-surface-400 hover:text-red-400">ğŸ—‘ï¸</button>}</div></td>}</tr>))}</tbody><tfoot className="bg-surface-800 border-t-2 border-primary-500"><tr className="font-bold"><td colSpan="5" className="px-3 md:px-4 py-3 text-right text-surface-200 text-xs">TOTAUX:</td><td className="px-3 md:px-4 py-3 text-right font-mono text-emerald-400">{fmt(tot.d)}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-secondary-400">{fmt(tot.c)}</td><td colSpan="2" className="px-3 md:px-4 py-3"><span className={cn('font-mono',tot.d-tot.c>=0?'text-emerald-400':'text-red-400')}>={fmt(tot.d-tot.c)}</span></td></tr></tfoot></table></div></div>)}
<Modal isOpen={show} onClose={()=>{setShow(false);setEdit(null);}} title={edit?'Modifier la transaction':'Nouvelle transaction'} size="lg"><TransForm trans={edit} banques={banques} params={params} isAdmin={user?.role==='Admin'} onSave={save} onCancel={()=>{setShow(false);setEdit(null);}} saving={saving}/></Modal></div>);};

const TransForm=({trans,banques,params,isAdmin,onSave,onCancel,saving})=>{const[f,setF]=useState({date:trans?.date||new Date().toISOString().split('T')[0],banqueId:trans?.banqueId||'',pays:trans?.pays||'Burkina Faso',projet:trans?.projet||'',noCheque:trans?.noCheque||'',demandeur:trans?.demandeur||'',sectionDem:trans?.sectionDem||'',nature:trans?.nature||'',designation:trans?.designation||'',beneficiaire:trans?.beneficiaire||'',sectionBen:trans?.sectionBen||'',debit:trans?.debit||'',credit:trans?.credit||'',centre:trans?.centre||'',statut:trans?.statut||'En attente entreprise',bDebit:trans?.bDebit||'',bCredit:trans?.bCredit||''});
const ch=(k,v)=>setF(p=>{const u={...p,[k]:v};if(k==='nature'){if(v==='Recette'){u.credit='';u.bCredit='';}else if(v==='DÃ©pense'){u.debit='';u.bDebit='';}}if(k==='banqueId'){const b=banques.find(x=>x.id===parseInt(v));if(b)u.pays=b.pays||'Burkina Faso';}return u;});
const go=e=>{e.preventDefault();if(!f.banqueId||!f.nature){alert('Banque et Nature sont obligatoires');return;}const b=banques.find(x=>x.id===parseInt(f.banqueId));onSave({...f,banqueId:parseInt(f.banqueId),banqueNom:b?.nom||'',debit:parse(f.debit),credit:parse(f.credit),bDebit:parse(f.bDebit),bCredit:parse(f.bCredit)});};
const isR=f.nature==='Recette',isD=f.nature==='DÃ©pense';
return(<form onSubmit={go} className="space-y-4"><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><Input label="Date" type="date" value={f.date} onChange={e=>ch('date',e.target.value)} required/><Select label="Banque" value={String(f.banqueId)} onChange={e=>ch('banqueId',e.target.value)} options={banques.map(b=>({value:String(b.id),label:b.nom}))} placeholder="SÃ©lectionner" required/><Select label="Pays" value={f.pays} onChange={e=>ch('pays',e.target.value)} options={params.pays}/></div><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><Input label="Projet" value={f.projet} onChange={e=>ch('projet',e.target.value)} placeholder="PRJ-001"/><Input label="NÂ° ChÃ¨que" value={f.noCheque} onChange={e=>ch('noCheque',e.target.value)}/><Select label="Nature" value={f.nature} onChange={e=>ch('nature',e.target.value)} options={params.natures} placeholder="SÃ©lectionner" required/></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><Input label="Demandeur" value={f.demandeur} onChange={e=>ch('demandeur',e.target.value)}/><Input label="Section demandeur" value={f.sectionDem} onChange={e=>ch('sectionDem',e.target.value)}/></div><Input label="DÃ©signation" value={f.designation} onChange={e=>ch('designation',e.target.value)} placeholder="Description"/><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><Input label="BÃ©nÃ©ficiaire" value={f.beneficiaire} onChange={e=>ch('beneficiaire',e.target.value)}/><Input label="Section bÃ©nÃ©ficiaire" value={f.sectionBen} onChange={e=>ch('sectionBen',e.target.value)}/></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><Input label="DÃ©bit (Encaissement)" value={String(f.debit)} onChange={e=>ch('debit',e.target.value)} disabled={isD} placeholder="0"/><Input label="CrÃ©dit (DÃ©caissement)" value={String(f.credit)} onChange={e=>ch('credit',e.target.value)} disabled={isR} placeholder="0"/></div>{isAdmin&&<div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-surface-900 rounded-xl border border-surface-700"><Input label="Banque DÃ©bit" value={String(f.bDebit)} onChange={e=>ch('bDebit',e.target.value)} disabled={isD}/><Input label="Banque CrÃ©dit" value={String(f.bCredit)} onChange={e=>ch('bCredit',e.target.value)} disabled={isR}/></div>}<div className="grid grid-cols-1 md:grid-cols-2 gap-4"><Input label="Centre d'intÃ©rÃªt" value={f.centre} onChange={e=>ch('centre',e.target.value)}/><Select label="Statut" value={f.statut} onChange={e=>ch('statut',e.target.value)} options={params.statuts}/></div><div className="flex justify-end gap-3 pt-4 border-t border-surface-700"><Button variant="secondary" onClick={onCancel}>Annuler</Button><Button type="submit" loading={saving}>{trans?'Modifier':'CrÃ©er'}</Button></div></form>);};

// ===== PAGE SOLDES =====
const Soldes=({trans,banques,showToast})=>{const sb=useMemo(()=>{const a=trans.filter(t=>!t.deletedAt&&t.statut!=='AnnulÃ©');const r={};banques.forEach(b=>{const bt=a.filter(t=>t.banqueNom===b.nom);const soldeOuv=parseFloat(b.solde_ouverture)||0;const mvtD=bt.reduce((s,t)=>s+(parseFloat(t.debit)||0),0);const mvtC=bt.reduce((s,t)=>s+(parseFloat(t.credit)||0),0);r[b.nom]={ouv:soldeOuv,d:mvtD,c:mvtC,s:soldeOuv+mvtD-mvtC,info:b};});return r;},[trans,banques]);
const tot=useMemo(()=>Object.values(sb).reduce((a,b)=>({ouv:a.ouv+b.ouv,d:a.d+b.d,c:a.c+b.c,s:a.s+b.s}),{ouv:0,d:0,c:0,s:0}),[sb]);
const expCSV=()=>{const rows=[['Banque','NÂ° Compte','Gestionnaire','Contact','Solde Ouverture','Encaissements','DÃ©caissements','Solde Final']];Object.entries(sb).forEach(([nom,d])=>rows.push([nom,d.info?.numero_compte||'',d.info?.gestionnaire||'',d.info?.contact||'',d.ouv,d.d,d.c,d.s]));const csv=rows.map(r=>r.join(';')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='soldes_'+new Date().toISOString().split('T')[0]+'.csv';a.click();showToast?.('CSV exportÃ©','success');};
const expPDF=()=>{const headers=['Banque','NÂ° Compte','Solde Ouv.','Encaiss.','DÃ©caiss.','Solde Final'];const rows=Object.entries(sb).map(([nom,d])=>[nom,d.info?.numero_compte||'-',fmt(d.ouv),fmt(d.d),fmt(d.c),fmt(d.s)]);const totals=['TOTAL','',fmt(tot.ouv),fmt(tot.d),fmt(tot.c),fmt(tot.s)];exportPDF('Ã‰tat des Soldes - '+new Date().toLocaleDateString('fr-FR'),headers,rows,totals,'soldes_'+new Date().toISOString().split('T')[0]);showToast?.('PDF gÃ©nÃ©rÃ©','success');};
if(banques.length===0)return(<div className="animate-fade-in pt-16 md:pt-0"><Empty icon="ğŸ¦" title="Aucune banque" desc="Configurez vos banques dans les paramÃ¨tres"/></div>);
return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0"><div className="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h1 className="text-2xl font-bold text-surface-100">Ã‰tat des Soldes</h1><p className="text-surface-400 mt-1">Au {new Date().toLocaleDateString('fr-FR')}</p></div><div className="flex gap-2"><Button variant="secondary" onClick={expPDF} icon="ğŸ“„">PDF</Button><Button variant="secondary" onClick={expCSV} icon="ğŸ“¥">CSV</Button></div></div><div className="glass rounded-xl p-5 border-2 border-primary-500/30"><h2 className="text-lg font-bold text-surface-100 mb-4">ğŸ¦ Total GÃ©nÃ©ral</h2><div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4"><div className="text-center p-3 md:p-4 bg-surface-800 rounded-xl border border-surface-700"><p className="text-xs md:text-sm text-surface-400 mb-1">Soldes d'ouverture</p><p className="text-lg md:text-xl font-mono font-bold text-surface-200">{fmt(tot.ouv)} F</p></div><div className="text-center p-3 md:p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/30"><p className="text-xs md:text-sm text-surface-400 mb-1">Encaissements</p><p className="text-lg md:text-xl font-mono font-bold text-emerald-400">{fmt(tot.d)} F</p></div><div className="text-center p-3 md:p-4 bg-secondary-500/10 rounded-xl border border-secondary-500/30"><p className="text-xs md:text-sm text-surface-400 mb-1">DÃ©caissements</p><p className="text-lg md:text-xl font-mono font-bold text-secondary-400">{fmt(tot.c)} F</p></div><div className={cn('text-center p-3 md:p-4 rounded-xl',tot.s>=0?'bg-emerald-500/20 border border-emerald-500/30':'bg-red-500/20 border border-red-500/30')}><p className="text-xs md:text-sm text-surface-400 mb-1">Solde Final</p><p className={cn('text-lg md:text-xl font-mono font-bold',tot.s>=0?'text-emerald-400':'text-red-400')}>{fmt(tot.s)} F</p></div></div></div><div className="glass rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-surface-800"><tr className="text-left text-xs text-surface-400"><th className="px-3 md:px-4 py-3">Banque</th><th className="px-3 md:px-4 py-3 hidden md:table-cell">NÂ° Compte</th><th className="px-3 md:px-4 py-3 hidden lg:table-cell">Gestionnaire</th><th className="px-3 md:px-4 py-3 text-right">Solde Ouv.</th><th className="px-3 md:px-4 py-3 text-right">Encaiss.</th><th className="px-3 md:px-4 py-3 text-right">DÃ©caiss.</th><th className="px-3 md:px-4 py-3 text-right">Solde Final</th></tr></thead><tbody className="divide-y divide-surface-800">{Object.entries(sb).sort((a,b)=>Math.abs(b[1].s)-Math.abs(a[1].s)).map(([nom,d])=>(<tr key={nom} className="table-row"><td className="px-3 md:px-4 py-3"><div className="flex items-center gap-2"><div className={cn('w-2 h-2 rounded-full',d.s>=0?'bg-emerald-500':'bg-red-500')}/><span className="text-surface-200 font-medium text-xs md:text-sm">{nom}</span></div></td><td className="px-3 md:px-4 py-3 font-mono text-surface-400 text-xs hidden md:table-cell">{d.info?.numero_compte||'-'}</td><td className="px-3 md:px-4 py-3 text-surface-300 text-xs hidden lg:table-cell">{d.info?.gestionnaire||'-'}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-surface-300 text-xs">{d.ouv?fmt(d.ouv):'-'}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-emerald-400 text-xs">{d.d?fmt(d.d):'-'}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-secondary-400 text-xs">{d.c?fmt(d.c):'-'}</td><td className={cn('px-3 md:px-4 py-3 text-right font-mono font-bold text-xs md:text-sm',d.s>=0?'text-emerald-400':'text-red-400')}>{fmt(d.s)}</td></tr>))}</tbody><tfoot className="bg-surface-800 border-t-2 border-primary-500"><tr className="font-bold"><td className="px-3 md:px-4 py-3 text-surface-200">TOTAL</td><td className="px-3 md:px-4 py-3 hidden md:table-cell"></td><td className="px-3 md:px-4 py-3 hidden lg:table-cell"></td><td className="px-3 md:px-4 py-3 text-right font-mono text-surface-200">{fmt(tot.ouv)}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-emerald-400">{fmt(tot.d)}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-secondary-400">{fmt(tot.c)}</td><td className={cn('px-3 md:px-4 py-3 text-right font-mono',tot.s>=0?'text-emerald-400':'text-red-400')}>{fmt(tot.s)}</td></tr></tfoot></table></div></div></div>);};

// ===== PAGE USERS =====
const Users=({data,showToast})=>{const{users,addUser,updateUser,deleteUser,resetPassword}=data;const[show,setShow]=useState(false);const[edit,setEdit]=useState(null);const[saving,setSaving]=useState(false);const[showReset,setShowReset]=useState(null);const[newPwd,setNewPwd]=useState('');
const save=async d=>{setSaving(true);try{if(edit)await updateUser(edit.id,d);else await addUser(d);setShow(false);setEdit(null);showToast?.(edit?'Utilisateur modifiÃ©':'Utilisateur crÃ©Ã©','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}setSaving(false);};
const del=async u=>{if(u.username==='Admin')return showToast?.('Impossible de supprimer Admin','error');if(confirm('Supprimer '+u.username+'?')){try{await deleteUser(u.id);showToast?.('Utilisateur supprimÃ©','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}}};
const doReset=async()=>{if(!newPwd||newPwd.length<4)return showToast?.('Mot de passe trop court (min 4 car.)','error');try{await resetPassword(showReset.id,newPwd);setShowReset(null);setNewPwd('');showToast?.('Mot de passe rÃ©initialisÃ©','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}};
return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0"><div className="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h1 className="text-2xl font-bold text-surface-100">Utilisateurs</h1><p className="text-surface-400 mt-1">{users.length} compte(s)</p></div><Button onClick={()=>{setEdit(null);setShow(true);}} icon="â•">Nouveau</Button></div>
<div className="glass rounded-xl p-4 mb-4"><h3 className="text-sm font-bold text-surface-300 mb-3">ğŸ“‹ RÃ´les disponibles :</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-3">{Object.entries(ROLES).map(([k,v])=>(<div key={k} className="p-3 bg-surface-800 rounded-lg"><div className="flex items-center gap-2 mb-2"><span>{v.icon}</span><span className="font-bold text-surface-200">{v.label}</span></div><p className="text-xs text-surface-400">{v.permissions.includes('manage_users')?'AccÃ¨s complet + gestion utilisateurs':v.permissions.includes('delete')?'CrÃ©er, modifier, supprimer':'Consultation uniquement'}</p></div>))}</div></div>
<div className="glass rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-surface-800"><tr className="text-left text-xs text-surface-400"><th className="px-3 md:px-4 py-3">Utilisateur</th><th className="px-3 md:px-4 py-3 hidden md:table-cell">Email</th><th className="px-3 md:px-4 py-3">RÃ´le</th><th className="px-3 md:px-4 py-3">Actions</th></tr></thead><tbody className="divide-y divide-surface-800">{users.map(u=>{const r=ROLES[u.role]||ROLES.User;return(<tr key={u.id} className="table-row"><td className="px-3 md:px-4 py-3"><div className="flex items-center gap-3"><div className={cn('w-8 md:w-10 h-8 md:h-10 rounded-full flex items-center justify-center text-white font-bold text-sm',u.role==='Admin'?'gradient-primary':u.role==='Observateur'?'gradient-gray':'gradient-success')}>{u.username.charAt(0)}</div><span className="text-surface-200 font-medium text-xs md:text-sm">{u.username}</span></div></td><td className="px-3 md:px-4 py-3 text-surface-400 text-xs hidden md:table-cell">{u.email||'-'}</td><td className="px-3 md:px-4 py-3"><Badge variant={r.color}>{r.icon} <span className="hidden md:inline">{r.label}</span></Badge></td><td className="px-3 md:px-4 py-3"><div className="flex gap-1"><button onClick={()=>{setEdit(u);setShow(true);}} className="p-1.5 hover:bg-surface-700 rounded text-surface-400 hover:text-primary-400" title="Modifier">âœï¸</button><button onClick={()=>{setShowReset(u);setNewPwd('');}} className="p-1.5 hover:bg-surface-700 rounded text-surface-400 hover:text-amber-400" title="RÃ©initialiser mot de passe">ğŸ”‘</button><button onClick={()=>del(u)} className="p-1.5 hover:bg-surface-700 rounded text-surface-400 hover:text-red-400" title="Supprimer">ğŸ—‘ï¸</button></div></td></tr>);})}</tbody></table></div></div>
<Modal isOpen={show} onClose={()=>{setShow(false);setEdit(null);}} title={edit?'Modifier':'Nouvel utilisateur'} size="sm"><UserForm user={edit} onSave={save} onCancel={()=>{setShow(false);setEdit(null);}} saving={saving}/></Modal>
<Modal isOpen={!!showReset} onClose={()=>setShowReset(null)} title="RÃ©initialiser le mot de passe" size="sm"><div className="space-y-4"><p className="text-surface-300">Nouveau mot de passe pour <span className="text-primary-400 font-bold">{showReset?.username}</span></p><Input label="Nouveau mot de passe" type="password" value={newPwd} onChange={e=>setNewPwd(e.target.value)} placeholder="Min. 4 caractÃ¨res" required/><div className="flex justify-end gap-3 pt-4 border-t border-surface-700"><Button variant="secondary" onClick={()=>setShowReset(null)}>Annuler</Button><Button onClick={doReset} icon="ğŸ”‘">RÃ©initialiser</Button></div></div></Modal></div>);};

const UserForm=({user,onSave,onCancel,saving})=>{const[d,setD]=useState({username:user?.username||'',email:user?.email||'',role:user?.role||'User',password:''});
const go=e=>{e.preventDefault();if(!d.username)return alert('Nom requis');if(!user&&!d.password)return alert('Mot de passe requis');onSave(d);};
return(<form onSubmit={go} className="space-y-4"><Input label="Nom d'utilisateur" value={d.username} onChange={e=>setD(p=>({...p,username:e.target.value}))} placeholder="Ex: Jean.Dupont" required/><Input label={user?'Nouveau mot de passe':'Mot de passe'} type="password" value={d.password} onChange={e=>setD(p=>({...p,password:e.target.value}))} placeholder={user?'Laisser vide si inchangÃ©':'CrÃ©er un mot de passe'} required={!user}/><Input label="Email" type="email" value={d.email} onChange={e=>setD(p=>({...p,email:e.target.value}))} placeholder="email@exemple.com"/><div><label className="block text-xs font-bold text-surface-300 mb-1.5">RÃ´le <span className="text-red-400">*</span></label><div className="grid grid-cols-1 gap-2">{Object.entries(ROLES).map(([k,v])=>(<button key={k} type="button" onClick={()=>setD(p=>({...p,role:k}))} className={cn('p-3 rounded-xl border text-left transition-all',d.role===k?'bg-primary-500/20 border-primary-500 text-primary-400':'bg-surface-800 border-surface-600 text-surface-300 hover:border-surface-500')}><div className="flex items-center gap-2"><span className="text-lg">{v.icon}</span><div><p className="font-bold text-sm">{v.label}</p><p className="text-xs opacity-70">{v.permissions.includes('manage_users')?'AccÃ¨s complet':v.permissions.includes('delete')?'CrÃ©er, modifier, supprimer':'Lecture seule'}</p></div></div></button>))}</div></div><div className="flex justify-end gap-3 pt-4 border-t border-surface-700"><Button variant="secondary" onClick={onCancel}>Annuler</Button><Button type="submit" loading={saving}>{user?'Modifier':'CrÃ©er'}</Button></div></form>);};

// ===== PAGE CORBEILLE =====
const Corbeille=({data,showToast})=>{const{trans,restoreTrans,permDeleteTrans}=data;const del=trans.filter(t=>t.deletedAt);const[loading,setLoading]=useState(null);
const rest=async t=>{if(confirm('Restaurer?')){setLoading(t.id);try{await restoreTrans(t.id);showToast?.('Transaction restaurÃ©e','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}setLoading(null);}};
const rm=async t=>{if(confirm('Supprimer dÃ©finitivement?')){setLoading(t.id);try{await permDeleteTrans(t.id);showToast?.('Transaction supprimÃ©e','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}setLoading(null);}};
return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0"><div className="flex items-center justify-between"><div><h1 className="text-2xl font-bold text-surface-100">Corbeille</h1><p className="text-surface-400 mt-1">{del.length} Ã©lÃ©ment(s)</p></div></div>{del.length===0?<div className="glass rounded-xl p-12"><Empty icon="ğŸ—‘ï¸" title="Corbeille vide" desc="Les transactions supprimÃ©es apparaÃ®tront ici"/></div>:(<div className="glass rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-surface-800"><tr className="text-left text-xs text-surface-400"><th className="px-3 md:px-4 py-3">SupprimÃ© le</th><th className="px-3 md:px-4 py-3 hidden md:table-cell">Par</th><th className="px-3 md:px-4 py-3">NÂ°</th><th className="px-3 md:px-4 py-3">DÃ©signation</th><th className="px-3 md:px-4 py-3 text-right">Montant</th><th className="px-3 md:px-4 py-3">Actions</th></tr></thead><tbody className="divide-y divide-surface-800">{del.map(t=>(<tr key={t.id} className="table-row"><td className="px-3 md:px-4 py-3 font-mono text-surface-400 text-xs">{fmtD(t.deletedAt)}</td><td className="px-3 md:px-4 py-3 text-surface-300 text-xs hidden md:table-cell">{t.deletedBy||'-'}</td><td className="px-3 md:px-4 py-3 font-mono text-surface-400 text-xs">{t.numero}</td><td className="px-3 md:px-4 py-3 text-surface-300 truncate max-w-[150px] text-xs">{t.designation}</td><td className="px-3 md:px-4 py-3 text-right font-mono text-xs">{t.debit&&parseFloat(t.debit)>0?<span className="text-emerald-400">{fmt(t.debit)}</span>:<span className="text-secondary-400">{fmt(t.credit)}</span>}</td><td className="px-3 md:px-4 py-3">{loading===t.id?<div className="loader" style={{width:20,height:20}}></div>:<div className="flex gap-1"><button onClick={()=>rest(t)} className="p-1.5 hover:bg-surface-700 rounded text-surface-400 hover:text-emerald-400">ğŸ”„</button><button onClick={()=>rm(t)} className="p-1.5 hover:bg-surface-700 rounded text-surface-400 hover:text-red-400">ğŸ—‘ï¸</button></div>}</td></tr>))}</tbody></table></div></div>)}</div>);};

// ===== PAGE PARAMETRES =====
const Settings=({data,user,showToast})=>{const{banques,params,addBanque,updateBanque,deleteBanque,addParam,updateParam,deleteParam}=data;
const[tab,setTab]=useState('banques');
const[showB,setShowB]=useState(false);
const[editB,setEditB]=useState(null);
const[saving,setSaving]=useState(false);
const[newItem,setNewItem]=useState('');
const[editItem,setEditItem]=useState(null);
const[editValue,setEditValue]=useState('');
const[adding,setAdding]=useState(false);

// Garder une rÃ©fÃ©rence stable de l'onglet actuel
const currentTab=useRef(tab);
useEffect(()=>{currentTab.current=tab;},[tab]);

const canEdit=canDo(user?.role,'update');
const tabs=[{id:'banques',label:'Banques',icon:'ğŸ¦',count:banques.length},{id:'pays',label:'Pays',icon:'ğŸŒ',count:params.pays.length},{id:'natures',label:'Natures',icon:'ğŸ“',count:params.natures.length},{id:'statuts',label:'Statuts',icon:'ğŸ“Š',count:params.statuts.length}];

const saveB=async d=>{const currentTabValue=currentTab.current;setSaving(true);try{if(editB)await updateBanque(editB.id,d);else await addBanque(d);setShowB(false);setEditB(null);showToast?.(editB?'Banque modifiÃ©e':'Banque ajoutÃ©e','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}setSaving(false);setTab(currentTabValue);};
const delB=async b=>{const currentTabValue=currentTab.current;if(confirm('Supprimer '+b.nom+'?')){try{await deleteBanque(b.id);showToast?.('Banque supprimÃ©e','success');}catch(e){showToast?.('Erreur: '+e.message,'error');}setTab(currentTabValue);}};

const getType=()=>tab==='natures'?'nature':tab==='statuts'?'statut':'pays';
const getItems=()=>params[tab]||[];

const handleAddItem=async()=>{
    const currentTabValue=currentTab.current;
    if(!newItem.trim())return showToast?.('Veuillez saisir une valeur','warning');
    if(getItems().includes(newItem.trim()))return showToast?.('Cette valeur existe dÃ©jÃ ','warning');
    setAdding(true);
    try{
        await addParam(getType(),newItem.trim());
        setNewItem('');
        showToast?.('Ã‰lÃ©ment ajoutÃ©','success');
    }catch(e){showToast?.('Erreur: '+e.message,'error');}
    setAdding(false);
    setTab(currentTabValue);
};

const handleUpdateItem=async(oldVal)=>{
    const currentTabValue=currentTab.current;
    if(!editValue.trim())return showToast?.('Veuillez saisir une valeur','warning');
    if(editValue.trim()===oldVal){setEditItem(null);return;}
    try{
        await updateParam(getType(),oldVal,editValue.trim());
        setEditItem(null);
        showToast?.('Ã‰lÃ©ment modifiÃ©','success');
    }catch(e){showToast?.('Erreur: '+e.message,'error');}
    setTab(currentTabValue);
};

const handleDeleteItem=async(val)=>{
    const currentTabValue=currentTab.current;
    if(confirm('Supprimer "'+val+'"?')){
        try{
            await deleteParam(getType(),val);
            showToast?.('Ã‰lÃ©ment supprimÃ©','success');
        }catch(e){showToast?.('Erreur: '+e.message,'error');}
        setTab(currentTabValue);
    }
};

const startEdit=(val)=>{setEditItem(val);setEditValue(val);};

return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0"><div><h1 className="text-2xl font-bold text-surface-100">ParamÃ¨tres</h1><p className="text-surface-400 mt-1">Configuration de l'application</p></div>
{!canEdit&&<Alert type="warning" message="Mode lecture seule - Vous ne pouvez pas modifier les paramÃ¨tres"/>}
<Tabs tabs={tabs} active={tab} onChange={setTab}/>

{tab==='banques'?(<div className="space-y-4"><div className="glass rounded-xl p-4 border-2 border-dashed border-primary-500/30"><div className="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h3 className="text-lg font-bold text-surface-100">Vos Banques</h3><p className="text-surface-400 text-sm">GÃ©rez les comptes avec leur solde d'ouverture</p></div>{canEdit&&<Button onClick={()=>{setEditB(null);setShowB(true);}} icon="â•">Ajouter une banque</Button>}</div></div>
{banques.length===0?(<div className="glass rounded-xl p-8"><Empty icon="ğŸ¦" title="Aucune banque configurÃ©e" desc="Ajoutez votre premiÃ¨re banque" action={canEdit&&<Button onClick={()=>setShowB(true)} icon="â•" size="lg">Ajouter ma premiÃ¨re banque</Button>}/></div>):(<div className="glass rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-surface-800"><tr className="text-left text-xs text-surface-400"><th className="px-3 md:px-4 py-3">Nom</th><th className="px-3 md:px-4 py-3 hidden md:table-cell">NÂ° Compte</th><th className="px-3 md:px-4 py-3 hidden lg:table-cell">Gestionnaire</th><th className="px-3 md:px-4 py-3 text-right">Solde Ouv.</th>{canEdit&&<th className="px-3 md:px-4 py-3">Actions</th>}</tr></thead><tbody className="divide-y divide-surface-800">{banques.map(b=>(<tr key={b.id} className="table-row"><td className="px-3 md:px-4 py-3"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-primary-500/20 flex items-center justify-center text-primary-400">ğŸ¦</div><div><span className="text-surface-200 font-medium block text-xs md:text-sm">{b.nom}</span><span className="text-surface-500 text-xs">{b.pays}</span></div></div></td><td className="px-3 md:px-4 py-3 font-mono text-surface-400 text-xs hidden md:table-cell">{b.numero_compte||'-'}</td><td className="px-3 md:px-4 py-3 hidden lg:table-cell"><div><span className="text-surface-300 text-xs block">{b.gestionnaire||'-'}</span><span className="text-surface-500 text-xs">{b.contact||''}</span></div></td><td className="px-3 md:px-4 py-3 text-right font-mono text-emerald-400 font-bold text-xs md:text-sm">{fmt(b.solde_ouverture||0)} F</td>{canEdit&&<td className="px-3 md:px-4 py-3"><div className="flex gap-1"><button onClick={()=>{setEditB(b);setShowB(true);}} className="p-1.5 hover:bg-surface-700 rounded text-surface-400 hover:text-primary-400">âœï¸</button><button onClick={()=>delB(b)} className="p-1.5 hover:bg-surface-700 rounded text-surface-400 hover:text-red-400">ğŸ—‘ï¸</button></div></td>}</tr>))}</tbody></table></div></div>)}
<Modal isOpen={showB} onClose={()=>{setShowB(false);setEditB(null);}} title={editB?'Modifier la banque':'Ajouter une banque'} size="md"><BanqueForm banque={editB} pays={params.pays} onSave={saveB} onCancel={()=>{setShowB(false);setEditB(null);}} saving={saving}/></Modal></div>):(
<div className="glass rounded-xl p-5">
<div className="flex flex-col md:flex-row gap-3 mb-6">
<p className="text-surface-300 text-sm flex-shrink-0 pt-2">
{tab==='pays'?'ğŸŒ GÃ©rer les pays disponibles':tab==='natures'?'ğŸ“ GÃ©rer les natures de transaction':'ğŸ“Š GÃ©rer les statuts'}
</p>
</div>

{canEdit&&(
<div className="flex gap-3 mb-6 p-4 bg-surface-800/50 rounded-xl border border-surface-700">
<input 
    type="text" 
    value={newItem} 
    onChange={e=>setNewItem(e.target.value)} 
    onKeyDown={e=>e.key==='Enter'&&handleAddItem()} 
    placeholder={`Ajouter ${tab==='pays'?'un pays':tab==='natures'?'une nature':'un statut'}...`} 
    className="flex-1 px-4 py-3 bg-surface-900 border border-surface-600 rounded-xl text-surface-100 text-sm focus:border-primary-500"
/>
<Button onClick={handleAddItem} icon="â•" loading={adding} size="md">Ajouter</Button>
</div>
)}

{getItems().length===0?(
<Empty icon={tab==='pays'?'ğŸŒ':tab==='natures'?'ğŸ“':'ğŸ“Š'} title="Liste vide" desc={`Aucun ${tab==='pays'?'pays':tab==='natures'?'type de nature':'statut'} configurÃ©`}/>
):(
<div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
{getItems().map((item,i)=>(
<div key={i} className="flex items-center justify-between p-4 bg-surface-800 rounded-xl group hover:bg-surface-700/50 border border-surface-700 transition-all">
{editItem===item?(
<div className="flex-1 flex gap-2">
<input 
    type="text" 
    value={editValue} 
    onChange={e=>setEditValue(e.target.value)} 
    onKeyDown={e=>{if(e.key==='Enter')handleUpdateItem(item);if(e.key==='Escape')setEditItem(null);}}
    className="flex-1 px-3 py-2 bg-surface-900 border border-primary-500 rounded-lg text-surface-100 text-sm"
    autoFocus
/>
<button onClick={()=>handleUpdateItem(item)} className="p-2 bg-emerald-500/20 hover:bg-emerald-500/30 rounded-lg text-emerald-400">âœ“</button>
<button onClick={()=>setEditItem(null)} className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg text-red-400">âœ•</button>
</div>
):(
<>
<span className="text-surface-200 font-medium">{item}</span>
{canEdit&&(
<div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
<button onClick={()=>startEdit(item)} className="p-1.5 hover:bg-surface-600 rounded text-surface-400 hover:text-primary-400" title="Modifier">âœï¸</button>
<button onClick={()=>handleDeleteItem(item)} className="p-1.5 hover:bg-surface-600 rounded text-surface-400 hover:text-red-400" title="Supprimer">ğŸ—‘ï¸</button>
</div>
)}
</>
)}
</div>
))}
</div>
)}
</div>
)}</div>);};

const BanqueForm=({banque,pays,onSave,onCancel,saving})=>{const[d,setD]=useState({nom:banque?.nom||'',numeroCompte:banque?.numero_compte||'',gestionnaire:banque?.gestionnaire||'',contact:banque?.contact||'',pays:banque?.pays||pays[0]||'',soldeOuverture:banque?.solde_ouverture||''});
const go=e=>{e.preventDefault();if(!d.nom){alert('Le nom est obligatoire');return;}onSave({...d,soldeOuverture:parse(d.soldeOuverture)});};
return(<form onSubmit={go} className="space-y-4"><Input label="Nom de la banque" value={d.nom} onChange={e=>setD(p=>({...p,nom:e.target.value}))} placeholder="Ex: CORIS BANK, BOA..." required/><Input label="NumÃ©ro de compte" value={d.numeroCompte} onChange={e=>setD(p=>({...p,numeroCompte:e.target.value}))} placeholder="Ex: BF001-2024-1234"/><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><Input label="Gestionnaire" value={d.gestionnaire} onChange={e=>setD(p=>({...p,gestionnaire:e.target.value}))} placeholder="Nom"/><Input label="Contact" value={d.contact} onChange={e=>setD(p=>({...p,contact:e.target.value}))} placeholder="+226 70 00 00 00"/></div><Select label="Pays" value={d.pays} onChange={e=>setD(p=>({...p,pays:e.target.value}))} options={pays}/><div className="p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/30"><Input label="ğŸ’° Solde d'ouverture (F CFA)" value={String(d.soldeOuverture)} onChange={e=>setD(p=>({...p,soldeOuverture:e.target.value}))} placeholder="Ex: 5000000"/><p className="text-xs text-emerald-400 mt-2">Solde initial du compte</p></div><div className="flex justify-end gap-3 pt-4 border-t border-surface-700"><Button variant="secondary" onClick={onCancel}>Annuler</Button><Button type="submit" loading={saving}>{banque?'Modifier':'Ajouter'}</Button></div></form>);};

// ===== PAGE ABONNEMENT =====
const AbonnementPage=({data,showToast})=>{
const{abonnement,getJoursRestants}=data;
const[selectedPlan,setSelectedPlan]=useState(null);
const[showContactModal,setShowContactModal]=useState(false);
const joursRestants=getJoursRestants();
const planActuel=PLANS[abonnement?.plan||'trial'];
const isExpire=abonnement?.isExpire||joursRestants<=0;

const handleSelectPlan=(planKey)=>{if(planKey===abonnement?.plan&&!isExpire)return;setSelectedPlan(planKey);setShowContactModal(true);};
const getWhatsAppLink=()=>{if(!selectedPlan)return'#';const plan=PLANS[selectedPlan];if(!plan)return'#';const message=encodeURIComponent(`Bonjour! Je souhaite souscrire au plan ${plan.nom} de Qashora.\nğŸ’° Montant: ${plan.prix.toLocaleString()} FCFA/mois`);return`https://wa.me/${WHATSAPP_CONTACT.replace('+','')}?text=${message}`;};

return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0">
<div><h1 className="text-2xl font-bold text-surface-100">ğŸ’ Abonnement</h1><p className="text-surface-400 mt-1">GÃ©rez votre plan</p></div>

<div className="glass rounded-2xl p-6 border-2 border-primary-500/30">
<div className="flex items-center gap-4">
<div className={cn('w-16 h-16 rounded-2xl flex items-center justify-center text-3xl shadow-lg',planActuel.gradient)}>{planActuel.icon}</div>
<div><p className="text-sm text-surface-400">Plan actuel</p><p className="text-xl font-bold text-surface-100">{planActuel.nom}</p>
{abonnement?.plan==='trial'&&<p className={cn('text-sm',isExpire?'text-red-400':'text-amber-400')}>{isExpire?'âš ï¸ ExpirÃ©':`â³ ${joursRestants} jours`}</p>}
{abonnement?.plan!=='trial'&&abonnement?.date_fin&&<p className={cn('text-sm',isExpire?'text-red-400':'text-emerald-400')}>{isExpire?'âš ï¸ ExpirÃ©':`âœ… Jusqu'au ${fmtD(abonnement.date_fin)}`}</p>}
</div>
</div>
</div>

<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
{Object.entries(PLANS).map(([key,plan])=>(<div key={key} className={cn('glass rounded-3xl overflow-hidden transition-all hover:shadow-2xl',abonnement?.plan===key&&!isExpire?'ring-2 ring-primary-500':'')}>
<div className={cn('p-6 text-white',plan.gradient)}><div className="flex justify-between items-start"><div><p className="text-white/80 text-sm">Plan</p><h3 className="text-2xl font-bold">{plan.nom}</h3></div><span className="text-3xl">{plan.icon}</span></div><div className="mt-4"><span className="text-4xl font-bold">{plan.prix>0?fmt(plan.prix):'Gratuit'}</span>{plan.prix>0&&<span className="text-white/80 ml-2">FCFA/mois</span>}</div></div>
<div className="p-6"><ul className="space-y-2">{plan.features.map((f,i)=><li key={i} className="flex items-center gap-2 text-sm text-surface-300"><span className="text-primary-400">âœ“</span>{f}</li>)}</ul>
<button onClick={()=>handleSelectPlan(key)} disabled={(abonnement?.plan===key&&!isExpire)||key==='trial'} className={cn('w-full mt-6 py-3 rounded-xl font-bold transition-all',(abonnement?.plan===key&&!isExpire)||key==='trial'?'bg-surface-700 text-surface-400 cursor-not-allowed':'gradient-primary text-white hover:shadow-lg')}>{abonnement?.plan===key&&!isExpire?'âœ“ Plan actuel':key==='trial'?'Essai':'Choisir'}</button>
</div></div>))}
</div>

<Modal isOpen={showContactModal&&!!selectedPlan} onClose={()=>setShowContactModal(false)} title={selectedPlan?`ğŸ“± Souscrire au plan ${PLANS[selectedPlan]?.nom||''}`:''} size="sm">
<div className="space-y-4">
{selectedPlan&&<><div className="p-4 bg-surface-800 rounded-xl text-center"><span className="text-4xl">{PLANS[selectedPlan]?.icon}</span><p className="text-xl font-bold text-surface-100 mt-2">{PLANS[selectedPlan]?.nom}</p><p className="text-2xl font-bold text-primary-400">{fmt(PLANS[selectedPlan]?.prix||0)} F/mois</p></div>
<p className="text-sm text-surface-300">Contactez-nous :</p>
<a href={getWhatsAppLink()} target="_blank" className="flex items-center gap-3 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-xl"><span className="text-2xl">ğŸ“±</span><div><p className="font-bold text-emerald-400">WhatsApp</p></div></a>
<p className="text-xs text-surface-500 text-center">Activation sous 24h aprÃ¨s paiement.</p></>}
</div>
</Modal>
</div>);};

// ===== PAGE ADMIN =====
const AdminPage=({showToast,isSuperAdmin})=>{
const[users,setUsers]=useState([]);
const[abonnements,setAbonnements]=useState([]);
const[loading,setLoading]=useState(true);
const[saving,setSaving]=useState(false);
const[showModal,setShowModal]=useState(false);
const[selectedUser,setSelectedUser]=useState(null);
const[searchTerm,setSearchTerm]=useState('');
const[form,setForm]=useState({plan:'trial',date_fin:'',montant:'',mode_paiement:'wave'});
const[message,setMessage]=useState({type:'',text:''});

useEffect(()=>{loadData();},[]);
const loadData=async()=>{setLoading(true);try{const{data:u}=await supabase.from('utilisateurs').select('*').order('created_at',{ascending:false});const{data:a}=await supabase.from('abonnements').select('*');setUsers(u||[]);setAbonnements(a||[]);}catch(e){console.error(e);}setLoading(false);};
const getAbonnement=(userId)=>abonnements.find(a=>a.user_id===userId);
const getJoursRestants=(dateFin)=>{if(!dateFin)return 0;return Math.ceil((new Date(dateFin)-new Date())/(1000*60*60*24));};
const openEditModal=(user)=>{const abo=getAbonnement(user.id);setSelectedUser(user);setForm({plan:abo?.plan||'trial',date_fin:abo?.date_fin?abo.date_fin.split('T')[0]:'',montant:abo?.montant?.toString()||'',mode_paiement:abo?.mode_paiement||'wave'});setShowModal(true);};

const handleSave=async()=>{if(!selectedUser)return;setSaving(true);setMessage({type:'',text:''});try{const abo=getAbonnement(selectedUser.id);const aboData={user_id:selectedUser.id,plan:form.plan,statut:'actif',date_debut:new Date().toISOString(),date_fin:form.date_fin?new Date(form.date_fin).toISOString():null,montant:parseInt(form.montant)||PLANS[form.plan].prix,mode_paiement:form.mode_paiement};
if(abo?.id){await supabase.from('abonnements').update(aboData).eq('id',abo.id);}else{await supabase.from('abonnements').insert([aboData]);}
setMessage({type:'success',text:`Plan ${form.plan} activÃ©!`});await loadData();setTimeout(()=>{setShowModal(false);setMessage({type:'',text:''});},1500);}catch(e){setMessage({type:'error',text:'Erreur: '+e.message});}setSaving(false);};

const quickActivate=async(user,plan,months=1)=>{setSaving(true);try{const dateFin=new Date();dateFin.setMonth(dateFin.getMonth()+months);const abo=getAbonnement(user.id);const aboData={user_id:user.id,plan,statut:'actif',date_debut:new Date().toISOString(),date_fin:dateFin.toISOString(),montant:PLANS[plan].prix,mode_paiement:'manual'};
if(abo?.id){await supabase.from('abonnements').update(aboData).eq('id',abo.id);}else{await supabase.from('abonnements').insert([aboData]);}
await loadData();showToast?.(`${plan} activÃ© pour ${user.username}`,'success');}catch(e){showToast?.('Erreur','error');}setSaving(false);};

const filteredUsers=users.filter(u=>u.username?.toLowerCase().includes(searchTerm.toLowerCase())||u.email?.toLowerCase().includes(searchTerm.toLowerCase()));
const stats={total:users.length,trial:users.filter(u=>(getAbonnement(u.id)?.plan||'trial')==='trial').length,standard:users.filter(u=>getAbonnement(u.id)?.plan==='standard').length,premium:users.filter(u=>getAbonnement(u.id)?.plan==='premium').length};

if(!isSuperAdmin)return(<div className="flex items-center justify-center min-h-[60vh] pt-16 md:pt-0"><div className="glass rounded-2xl p-8 text-center"><span className="text-6xl">ğŸ”’</span><h2 className="text-xl font-bold text-surface-100 mt-4">AccÃ¨s RefusÃ©</h2></div></div>);
if(loading)return<div className="flex justify-center py-20 pt-16 md:pt-0"><Loader text="Chargement..."/></div>;

return(<div className="space-y-6 animate-fade-in pt-16 md:pt-0">
<div className="flex justify-between items-center"><div><h1 className="text-2xl font-bold text-surface-100">ğŸ›¡ï¸ Administration</h1><p className="text-surface-400 mt-1">Gestion des abonnements</p></div><Button onClick={loadData} variant="secondary" icon="ğŸ”„" size="sm">Actualiser</Button></div>

<div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
<StatCard icon="ğŸ‘¥" label="Total" value={stats.total} gradient="gradient-gray"/>
<StatCard icon="ğŸ" label="Essai" value={stats.trial} gradient="gradient-warning"/>
<StatCard icon="â­" label="Standard" value={stats.standard} gradient="gradient-secondary"/>
<StatCard icon="ğŸ‘‘" label="Premium" value={stats.premium} gradient="gradient-primary"/>
</div>

<div className="glass rounded-xl p-4"><Input label="ğŸ” Rechercher" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Nom, email..."/></div>

<div className="glass rounded-xl overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-surface-800"><tr className="text-left text-xs text-surface-400"><th className="px-4 py-3">Utilisateur</th><th className="px-4 py-3">Email</th><th className="px-4 py-3 text-center">Plan</th><th className="px-4 py-3 text-center">Expire</th><th className="px-4 py-3 text-right">Actions</th></tr></thead>
<tbody className="divide-y divide-surface-800">{filteredUsers.map(user=>{const abo=getAbonnement(user.id);const plan=abo?.plan||'trial';const jours=getJoursRestants(abo?.date_fin);const isExpired=jours<=0;
return(<tr key={user.id} className="table-row"><td className="px-4 py-3"><div className="flex items-center gap-3"><div className="w-10 h-10 gradient-primary rounded-xl flex items-center justify-center text-white font-bold">{user.username?.charAt(0)||'?'}</div><span className="font-bold text-sm text-surface-200">{user.username}</span></div></td>
<td className="px-4 py-3 text-surface-400 text-sm">{user.email||'-'}</td>
<td className="px-4 py-3 text-center"><Badge variant={plan==='premium'?'primary':plan==='standard'?'info':'default'}>{PLANS[plan]?.icon} {PLANS[plan]?.nom}</Badge></td>
<td className="px-4 py-3 text-center">{abo?.date_fin?<span className={cn('text-sm font-bold',isExpired?'text-red-400':'text-surface-300')}>{jours>0?`${jours}j`:'ExpirÃ©'}</span>:<span className="text-surface-500">-</span>}</td>
<td className="px-4 py-3"><div className="flex justify-end gap-1"><button onClick={()=>quickActivate(user,'standard',1)} disabled={saving} className="px-2 py-1 text-xs font-bold bg-secondary-500/20 text-secondary-400 rounded-lg hover:bg-secondary-500/30">â­</button><button onClick={()=>quickActivate(user,'premium',1)} disabled={saving} className="px-2 py-1 text-xs font-bold bg-primary-500/20 text-primary-400 rounded-lg hover:bg-primary-500/30">ğŸ‘‘</button><button onClick={()=>openEditModal(user)} className="px-2 py-1 text-xs font-bold bg-surface-700 text-surface-300 rounded-lg hover:bg-surface-600">âœï¸</button></div></td></tr>);})}</tbody></table></div></div>

<Modal isOpen={showModal} onClose={()=>setShowModal(false)} title={`âœï¸ ${selectedUser?.username}`} size="sm">
<div className="space-y-4">
{message.text&&<Alert type={message.type} message={message.text}/>}
<Select label="Plan" value={form.plan} onChange={e=>setForm({...form,plan:e.target.value,montant:PLANS[e.target.value].prix.toString()})} options={[{value:'trial',label:'ğŸ Essai'},{value:'standard',label:'â­ Standard - 5000 F'},{value:'premium',label:'ğŸ‘‘ Premium - 15000 F'}]}/>
<Input label="Date de fin" type="date" value={form.date_fin} onChange={e=>setForm({...form,date_fin:e.target.value})}/>
<div className="grid grid-cols-2 gap-3"><Input label="Montant" type="number" value={form.montant} onChange={e=>setForm({...form,montant:e.target.value})}/><Select label="Paiement" value={form.mode_paiement} onChange={e=>setForm({...form,mode_paiement:e.target.value})} options={[{value:'wave',label:'Wave'},{value:'orange_money',label:'OM'},{value:'bank',label:'Virement'},{value:'manual',label:'Manuel'}]}/></div>
<div><p className="text-xs text-surface-500 mb-2">âš¡ Raccourcis</p><div className="flex gap-2">{[1,3,6,12].map(m=><button key={m} onClick={()=>{const d=new Date();d.setMonth(d.getMonth()+m);setForm({...form,date_fin:d.toISOString().split('T')[0]});}} className="px-3 py-1 text-xs font-bold bg-surface-700 text-surface-300 rounded-lg hover:bg-surface-600">{m}m</button>)}</div></div>
<div className="flex justify-end gap-3 pt-4 border-t border-surface-700"><Button variant="secondary" onClick={()=>setShowModal(false)}>Annuler</Button><Button onClick={handleSave} loading={saving}>Enregistrer</Button></div>
</div>
</Modal>
</div>);};

// ===== APPLICATION PRINCIPALE =====
const App=()=>{
const[user,setUser]=useState(null);
const[view,setView]=useState('landing'); // landing, login, register, confirmEmail, app
const[confirmEmail,setConfirmEmail]=useState('');
const[page,setPage]=useState('dashboard');
const[sidebarOpen,setSidebarOpen]=useState(false);
const[toast,setToast]=useState(null);

// useData avec organisation_id de l'utilisateur connectÃ©
const data=useData(user?.organisation_id);

const showToast=(message,type='info')=>setToast({message,type});
const isSuperAdmin=SUPER_ADMINS.includes(user?.email);

const handleLogin=(u)=>{setUser(u);setView('app');showToast('Bienvenue '+u.username+' !','success');};
const handleLogout=async()=>{await supabase.auth.signOut();setUser(null);setView('landing');};
const handleNeedConfirmation=(email)=>{setConfirmEmail(email);setView('confirmEmail');};

// Pages publiques
if(view==='landing')return<LandingPage onGoLogin={()=>setView('login')} onGoRegister={()=>setView('register')}/>;
if(view==='register')return<RegisterPage onGoLogin={()=>setView('login')} onNeedConfirmation={handleNeedConfirmation}/>;
if(view==='confirmEmail')return<ConfirmEmailPage email={confirmEmail} onGoLogin={()=>setView('login')}/>;
if(view==='login')return<Login onLogin={handleLogin} onGoRegister={()=>setView('register')} onGoLanding={()=>setView('landing')}/>;

// App (utilisateur connectÃ©)
if(!user)return(<div className="min-h-screen flex items-center justify-center"><Loader text="Chargement..." size="lg"/></div>);
if(data.loading)return(<div className="min-h-screen flex items-center justify-center"><Loader text="Chargement des donnÃ©es..." size="lg"/></div>);
if(data.error)return(<div className="min-h-screen flex items-center justify-center p-4"><Alert type="error" message={'Erreur: '+data.error}/></div>);

return(<div className="min-h-screen bg-surface-950">
<Side page={page} nav={setPage} user={user} logout={handleLogout} isOpen={sidebarOpen} toggle={()=>setSidebarOpen(!sidebarOpen)} isSuperAdmin={isSuperAdmin}/>
<main className="main-content md:ml-64 p-4 md:p-8">
{page==='dashboard'&&<Dashboard trans={data.trans} banques={data.banques} onNavigate={setPage}/>}
{page==='transactions'&&<Transactions data={data} user={user} showToast={showToast}/>}
{page==='soldes'&&<Soldes trans={data.trans} banques={data.banques} showToast={showToast}/>}
{page==='users'&&user?.role==='Admin'&&<Users data={data} showToast={showToast}/>}
{page==='corbeille'&&user?.role==='Admin'&&<Corbeille data={data} showToast={showToast}/>}
{page==='abonnement'&&<AbonnementPage data={data} showToast={showToast}/>}
{page==='settings'&&<Settings data={data} user={user} showToast={showToast}/>}
{page==='admin'&&<AdminPage showToast={showToast} isSuperAdmin={isSuperAdmin}/>}
</main>
{toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}
</div>);
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
